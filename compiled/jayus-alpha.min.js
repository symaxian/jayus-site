function overloadArgumentCount(a,b){return overloadArgumentCount.verifySubFunctions?function(){if("function"===typeof a[arguments.length])return a[arguments.length].apply(this,arguments);if("string"===typeof b)throw new TypeError('Overloaded function "'+b+'" has no sub-function available for argument count: '+arguments.length);throw new TypeError("Overloaded function has no sub-function available for argument count: "+arguments.length);}:function(){return a[arguments.length].apply(this,arguments)}}
function overloadArgumentType(a,b){return overloadArgumentType.verifySubFunctions?function(c){if("function"===typeof a[typeof c])return a[typeof c].apply(this,arguments);if("string"===typeof b)throw new TypeError('Overloaded function "'+b+'" has no sub-function available for argument type: '+typeof c);throw new TypeError("Overloaded function has no sub-function available for argument type: "+typeof c);}:function(c){return a[typeof c].apply(this,arguments)}}
overloadArgumentCount.verifySubFunctions=true;overloadArgumentType.verifySubFunctions=true;/*


 Copyright ? 2011 Jonathon Reesor

 This file is part of Jayus.

 Jayus is free software: you can redistribute it and/or modify
 it under the terms of the GNU General Public License as published by
 the Free Software Foundation, either version 3 of the License, or
 (at your option) any later version.

 Jayus is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 GNU General Public License for more details.

 You should have received a copy of the GNU General Public License
 along with Jayus.  If not, see <http://www.gnu.org/licenses/>.
*/
jayus={running:false,frameIntervalRunning:false,lastFrameTime:0,interval:null,useReqAnimFrame:true,framerate:60,displays:[],hasFocus:false,focusedDisplay:null,cursorFocus:null,animators:[],frameEventData:{},fontCache:{},fontCacheMaxChar:255,DIRTY:{VISIBILITY:1,POSITION:2,SIZE:4,TRANSFORMS:8,CONTENT:16,STYLE:32,BACKGROUND:16,FRAME:6,SCOPE:14,ALL:127},SHAPES:{LIST:-1,CUSTOM:0,POINT:1,CIRCLE:2,RECTANGLE:4,POLYGON:8,PATH:16},intersectTest:function(a,b){var c;c=a.shapeType;for(var d=b.shapeType;!c;){a=
a.getBounds();c=a.shapeType}for(;!d;){b=b.getBounds();d=b.shapeType}if(c===-1){for(c=0;c<a.items.length;c++)if(this.intersectTest(a[c],b))return true;return false}if(d===-1){for(c=0;c<b.items.length;c++)if(this.intersectTest(a,b[c]))return true;return false}if(c>d){c=a;a=b;b=c}switch(a.shapeType+b.shapeType){case 2:return a.x===b.x&&a.y===b.y;case 3:return b.intersectsAt(a.x,a.y);case 4:return(a.x-b.x)*(a.x-b.x)+(a.y-b.y)*(a.y-b.y)<=(a.radius+b.radius)*(a.radius+b.radius);case 5:return b.intersectsAt(a.x,
a.y);case 6:c=Math.abs(a.x-(b.x+b.width/2));d=Math.abs(a.y-(b.y+b.height/2));if(c>b.width/2+a.radius)return false;if(d>b.height/2+a.radius)return false;if(c<=b.width/2)return true;if(d<=b.height/2)return true;return(c-b.width/2)*(c-b.width/2)+(d-b.height/2)*(d-b.height/2)<=a.radius*a.radius;case 8:return!(a.x+a.width<b.x||a.y+a.height<b.y||a.x>b.x+b.width||a.y>b.y+b.height);case 9:return b.intersectsAt(a.x,a.y);case 10:throw Error("TODO: Circle intersects Polygon");case 12:throw Error("TODO: Rectangle intersects Polygon");
case 9:throw Error("TODO: Polygon intersects Polygon");case 17:return b.intersectsAt(a.x,a.y);case 18:throw Error("TODO: Circle intersects Path");case 20:throw Error("TODO: Rectangle intersects Path");case 24:throw Error("TODO: Polygon intersects Path");case 32:throw Error("TODO: Circle intersects Path");}},distance:function(a,b){var c=a.x-b.x,d=a.y-b.y;return Math.sqrt(c*c+d*d)},copyObject:function(a){return this.applyObject(a,{})},applyObject:function(a,b){for(var c in a)if(a.hasOwnProperty(c))b[c]=
a[c];return b},createClass:function(a){var b=function(){this.init.apply(this,arguments)};b.prototype=a;if(typeof b.prototype.init!=="function")b.prototype.init=function(){};b.init=function(c,d){b.prototype.init.apply(c,d)};b.extend=jayus.extendMethod;return b},extendMethod:function(a){var b=function(){this.init.apply(this,arguments)};b.prototype=Object.create(this.prototype);jayus.applyObject(a,b.prototype);if(typeof b.prototype.init!=="function")b.prototype.init=function(){};b.init=function(c,d){b.prototype.init.apply(c,
d)};b.extend=jayus.extendMethod;return b},init:function(){var a=document.createElement("canvas");if(!(typeof a.getContext==="function"&&typeof a.getContext("2d")==="object"))throw Error("Fatal error, browser does not support the canvas element, unable to initiate Jayus");this.applyObject(this.Responder.prototype,this);this.addDefaultHandlers();this.ua=this.detectBrowser();this.ua.lineDash=typeof this.getContext().setLineDash==="function";window.requestAnimationFrame=window.requestAnimationFrame||
window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame;this.ua.requestAnimationFrame=typeof window.requestAnimationFrame==="function";this.keyboard.init();this.colors.cssNames=[];for(a=0;a<this.colors.displayNames.length;a++)this.colors.cssNames.push(this.colors.displayNames[a].replace(" ","").replace(" ","").toLowerCase());this.initialized=true},detectBrowser:function(){var a=[{src:navigator.platform,str:"Win",id:"Windows"},
{src:navigator.platform,str:"Mac",id:"Mac"},{src:navigator.userAgent,str:"iPhone",id:"iPhone/iPod"},{src:navigator.platform,str:"Linux",id:"Linux"}],b,c=function(e){for(var f=0;f<e.length;f++){var h=e[f].src,g=e[f].prop;b=e[f].ver||e[f].id;if(h){if(h.indexOf(e[f].str)!==-1)return e[f].id}else if(g)return e[f].id}},d=function(e){var f=e.indexOf(b);if(f!==-1)return parseFloat(e.substring(f+b.length+1))};return{browser:c([{src:navigator.userAgent,str:"Chrome",id:"Chrome"},{src:navigator.userAgent,str:"OmniWeb",
ver:"OmniWeb/",id:"OmniWeb"},{src:navigator.vendor,str:"Apple",id:"Safari",ver:"Version"},{prop:window.opera,id:"Opera",ver:"Version"},{src:navigator.vendor,str:"iCab",id:"iCab"},{src:navigator.vendor,str:"KDE",id:"Konqueror"},{src:navigator.userAgent,str:"Firefox",id:"Firefox"},{src:navigator.vendor,str:"Camino",id:"Camino"},{src:navigator.userAgent,str:"Netscape",id:"Netscape"},{src:navigator.userAgent,str:"MSIE",id:"Explorer",ver:"MSIE"},{src:navigator.userAgent,str:"Gecko",id:"Mozilla",ver:"rv"},
{src:navigator.userAgent,str:"Mozilla",id:"Netscape",ver:"Mozilla"}])||null,version:d(navigator.userAgent)||d(navigator.appVersion)||null,OS:c(a)||null}},start:function(){if(this.initialized)if(!this.running){this.running=true;if(!this.useReqAnimFrame||!this.ua.requestAnimationFrame)this.interval=setInterval(jayus.step,1E3/this.framerate);if(!this.frameIntervalRunning){this.lastFrameTime=Date.now();this.frameIntervalRunning=true;this.step()}}},stop:function(){if(this.running){this.running=false;clearInterval(this.interval)}},
step:function(){if(jayus.running){jayus.useReqAnimFrame&&jayus.ua.requestAnimationFrame&&window.requestAnimationFrame(jayus.step);var a,b,c=Date.now();a=c-jayus.lastFrameTime;var d=a/1E3;jayus.fps=1E3/a;jayus.lastFrameTime=c;jayus.frameEventData.elapsed=d;if(!jayus.isHandler.frame||!jayus.fire("frame",jayus.frameEventData)){for(a=0;a<jayus.displays.length;a++){b=jayus.displays[a];if(b.hasPendingMousemoveEvent){b.processPendingMousemove();b.hasPendingMousemoveEvent=false}}for(a=0;a<jayus.animators.length;a++)jayus.animators[a].tick(c,
d);jayus.box2d.enabled&&jayus.box2d.step(d);for(a=0;a<jayus.displays.length;a++){b=jayus.displays[a];b.dirtied&&b.refreshBuffer()}}}else jayus.frameIntervalRunning=false},addDefaultHandlers:function(){jayus.addHandler("keyPress",function(a){if(a.key==="grave"&&a.event.ctrlKey){jayus.chart.isVisible()?jayus.chart.hide():jayus.chart.show();return true}});jayus.addHandler("keyPress",function(a){if(a.key==="backslash"){lol=Cel.wrappers[0].exportChart();document.body.appendChild(lol);return true}})},chart:{routines:{render:{description:"Rendering",
time:0,color:"saddlebrown"},box2d:{description:"Box2D updating",time:0,color:"blue"},animation:{description:"Animation",time:0,color:"orange"},cursor:{description:"Cursor events",time:0,color:"Chartreuse"}},routineNameStack:[],routineTimeStack:[],routineInitStack:[],markColor:"grey",markFont:"10px sans-serif",display:null,graphSurface:null,topMS:40,index:0,width:500,height:380,visible:false,initialized:false,windowSize:120,windowIndex:0,barHeight:20,barSpacing:10,routineData:{},getRoutineColor:function(a){switch(a){case "render":return"saddlebrown";
case "box2d":return"blue";case "cursor":return"Chartreuse";case "animation":return"orange"}return"white"},begin:function(a){this.routineNameStack.push(a);this.routineTimeStack.push(Date.now());this.routineInitStack.push(0)},end:function(){var a=Date.now()-this.routineTimeStack.pop(),b=this.routineNameStack.pop(),c=this.routineInitStack.pop(),d,e;if(typeof this.routines[b]!=="object")this.routines[b]={description:"",time:0,color:"red"};if(this.initialized){d=this.routineData[b];if(d===undefined){d=
{visible:true,latencies:[],averageLatency:0,inits:[],initTotal:0,color:this.getRoutineColor(b),bar:new jayus.Scene(0,this.barHeight),label:new jayus.Text(b[0].toUpperCase()+b.slice(1),"16px sans-serif",{fill:"black"}),tag:new jayus.Text("","12px sans-serif",{fill:"black"})};d.bar.setBg({fill:d.color});for(e=0;e<this.windowSize;e++){d.latencies.push(0);d.inits.push(0)}this.routineData[b]=d;this.graph2.children.add(d.bar,d.label,d.tag)}d.time+=a;d.latencyTotal-=d.latencies[this.windowIndex];d.latencies[this.windowIndex]=
a;d.inits+=c}this.routines[b].time+=a},tallyInit:function(){this.routineInitStack[this.routineInitStack.length-1]++},isVisible:function(){return this.initialized&&this.display.visible},show:function(){if(!this.initialized){this.vBox=new jayus.vBox;this.vBox.setOrigin(2,0).setSize(this.width,this.height);this.topLabel=new jayus.Text("","13px sans-serif",{fill:"#DDD"});this.graph=new jayus.Scene;this.graph.setOptimizedBuffering(false);this.graph2=(new jayus.Scene).setBg({fill:"dimgrey"});this.graph2.setOptimizedBuffering(false);
this.vBox.children.add(this.topLabel,this.graph,this.graph2);this.graphSurface=new jayus.Surface(this.graph.width,this.graph.height);this.graph.children.add(this.graphSurface);this.graph.addHandler("resized",function(){var e=function(f){var h=jayus.chart.graph.height-f/jayus.chart.topMS*jayus.chart.graph.height,g=new jayus.PaintedShape(new jayus.Polygon.Line(0,Math.floor(h)+0.5,jayus.chart.graph.width,Math.floor(h)+0.5),{stroke:"dimgrey"});h=(new jayus.Text(f+" ms","10px sans-serif",{fill:"dimgrey"})).setOrigin(4,
h-12);jayus.chart.graph.children.update(f+"line",g.setId(f+"line")).update(f+"text",h.setId(f+"text"))};e(16);e(33);jayus.chart.graphSurface.setHeight(this.height)});this.graph.fire("resized");this.display=new jayus.Display(this.width,this.height);this.display.children.add(this.vBox);var a=this.display.canvas,b=false,c,d;a.onmousemove=function(e){if(b){a.style.left=e.pageX-c+"px";a.style.top=e.pageY-d+"px"}};a.onmousedown=function(e){b=true;c=e.layerX;d=e.layerY};a.onmouseup=function(){b=false};a.style.position=
"absolute";a.style.border="#aaa 1px solid";a.style.backgroundColor="black";this.display.setCursor("move");document.body.appendChild(a);a.style.left="50px";a.style.top="50px";this.initialized=true}this.display.show()},hide:function(){if(this.initialized){this.display.hide();this.graphSurface.clear();this.index=0}},mark:function(a){if(this.isVisible()){var b=this.graphSurface.context,c=jayus.measureText(a,this.markFont);b.fillStyle=this.markColor;b.fillRect(this.index,0,1,this.graph.height-0.5);b.fillText(a,
this.index-c.width-2,c.ascent)}},order:["render","box2d","animation","cursor"],update:function(){if(this.isVisible()){var a=this.graphSurface.context,b=this.graphSurface.height,c,d,e;if(this.routineData.render.time===0)this.routineData.render.time=1;var f=0,h=0,g=[];for(c in this.routineData){d=this.routineData[c];g.push(c);d.averageLatency=jayus.math.average(d.latencies);h+=d.averageLatency;e=d.label.width;if(e>f)f=e;d.visible=d.averageLatency>0}f+=10;g.sort(function(i,j){return jayus.chart.routineData[i].averageLatency<
jayus.chart.routineData[j].averageLatency});for(c=0;c<g.length;c++){d=this.routineData[g[c]];e=Math.floor(d.time/this.topMS*this.graph.height);a.fillStyle=d.color;a.fillRect(this.index,b-e,1,e-0.5);b-=e;d.time=0;d.inits=0}a.clearRect(this.index+1,0,2,this.graph.height);this.index++;if(this.index===this.graph.width)this.index=-1;this.topLabel.setText("Framerate: "+(jayus.fps+"").substr(0,4));for(c=0;c<g.length;c++){d=this.routineData[g[c]];a=d.bar;b=10+c*(this.barSpacing+this.barHeight);if(d.visible){a.setOrigin(f,
b);a.setWidth(d.averageLatency/h*(this.graph2.width-f));d.label.setOrigin(5,a.y+a.height/2-d.label.height/2);d.tag.setText(Math.round(d.averageLatency)+" ms");d.tag.setOrigin(a.x+a.width-d.tag.width-10,a.y+a.height/2-d.tag.height/2);a.show();d.label.show();d.tag.show()}else{a.hide();d.label.hide();d.tag.hide()}}this.windowIndex++;if(this.windowIndex===this.windowSize)this.windowIndex=0;this.graphSurface.dirty(jayus.DIRTY.ALL);this.display.refreshBuffer()}}},getFontDescriptor:function(a){this.isFontCached(a)||
this.cacheFont(a);return this.fontCache[a]},cacheFont:function(a){var b,c,d;if(!this.isFontCached(a)){d=[];c=this.getContext();c.save();c.font=a;for(b=0;b<this.fontCacheMaxChar+1;b++)d[b]=c.measureText(String.fromCharCode(b)).width;c.restore();b=this.getVerticalFontMetrics(a);b.charWidths=d;this.fontCache[a]=b}},cacheFonts:function(a){for(var b=0;b<a.length;b++)this.cacheFont(a[b])},isFontCached:function(a){return typeof this.fontCache[a]==="object"},measureText:function(a,b){return this.measureTextOnto(a,
b,{})},measureTextOnto:function(a,b,c){this.cacheFont(b);b=jayus.fontCache[b];var d=b.charWidths,e,f=0;for(e=0;e<a.length;e++)f+=d[a.charCodeAt(e)];c.width=f;c.ascent=b.ascent;c.descent=b.descent;c.height=b.height;return c},getVerticalFontMetrics:function(a){var b={},c=document.createElement("span"),d=document.createElement("div"),e=document.createElement("div");c.style.font=a;c.innerText="Hg";d.style.display="inline-block";d.style.width="1px";d.style.height="0";e.appendChild(c);e.appendChild(d);
document.body.appendChild(e);try{d.style.verticalAlign="baseline";b.ascent=d.offsetTop-c.offsetTop;d.style.verticalAlign="bottom";b.height=d.offsetTop-c.offsetTop;b.descent=b.height-b.ascent}finally{document.body.removeChild(e)}return b},box2d:{enabled:true,scale:0.5,worlds:[],velocityIterations:10,positionIterations:10,physicalEntities:[],addWorld:function(a){this.worlds.push(a)},removeWorld:function(){this.worlds.splice(this.worlds.indexOf(this.world),1)},step:function(a){var b,c;for(b=0;b<this.worlds.length;b++){c=
this.worlds[b];c.Step(a,this.velocityIterations,this.positionIterations);c.ClearForces()}for(b=0;b<this.physicalEntities.length;b++)this.physicalEntities[b].updateFromBody()},drawDebug:function(){for(var a=0;a<this.worlds.length;a++)this.worlds[a].DrawDebugData()}},getContext:function(){if(this.displays.length)return this.displays[0].context;return document.createElement("canvas").getContext("2d")},math:{randomFrom:function(a){return a[this.randomBetween(0,a.length-1)]},randomBetween:function(a,b){return a+
Math.floor((b-a+1)*Math.random())},clamp:function(a,b,c){if(b<a)return a;if(b>c)return c;return b},min:function(a){var b,c,d=a[0];for(b=1;b<a.length;b++){c=a[b];if(c<d)d=c}return d},max:function(a){var b,c,d=a[0];for(b=1;b<a.length;b++){c=a[b];if(c>d)d=c}return d},average:function(a){var b,c=0;for(b=0;b<a.length;b++)c+=a[b];return c/a.length},toDegrees:function(a){return a*(180/Math.PI)},toRadians:function(a){return a*(Math.PI/180)},vFlipAngle:function(a){return 2*Math.PI-a},hFlipAngle:function(a){a=
Math.PI-a;if(a<0)a+=2*Math.PI;return a},getCwAngleBetween:function(a,b){var c=a-b;if(c<0)c+=2*Math.PI;return c},getCcwAngleBetween:function(a,b){var c=b-a;if(c<0)c+=2*Math.PI;return c}},colors:{displayNames:["Alice Blue","Antique White","Aqua","Aquamarine","Azure","Beige","Bisque","Black","Blanched Almond","Blue","Blue Violet","Brown","Burly Wood","Cadet Blue","Chartreuse","Chocolate","Coral","Cornflower Blue","Cornsilk","Crimson","Cyan","Dark Blue","Dark Cyan","Dark Goldenrod","Dark Grey","Dark Green",
"Dark Khaki","Dark Magenta","Dark Olive Green","Dark Orange","Dark Orchid","Dark Red","Dark Salmon","Dark Sea Green","Dark Slate Blue","Dark Slate Grey","Dark Turquoise","Dark Violet","Deep Pink","Deep Sky Blue","Dim Grey","Dodger Blue","Firebrick","Floral White","Forest Green","Fuchsia","Gainsboro","Ghost White","Gold","Goldenrod","Grey","Green","Green Yellow","Honeydew","Hot Pink","Indian Red","Indigo","Ivory","Khaki","Lavender","Lavender Blush","Lawn Green","Lemon Chiffon","Light Blue","Light Coral",
"Light Cyan","Light Goldenrod","Light Green","Light Grey","Light Pink","Light Salmon","Light Sea Green","Light Sky Blue","Light Slate Grey","Light Steel Blue","Light Yellow","Lime","Lime Green","Linen","Magenta","Maroon","Medium Aquamarine","Medium Blue","Medium Orchid","Medium Purple","Medium Sea Green","Medium Slate Blue","Medium Spring Green","Medium Turquoise","Medium Violet Red","Midnight Blue","Mint Cream","Misty Rose","Moccasin","Navajo White","Navy","Old Lace","Olive","Olive Drab","Orange",
"Orange Red","Orchid","Pale Goldenrod","Pale Green","Pale Turquoise","Pale Violet Red","Papaya Whip","Peach Puff","Peru","Pink","Plum","Powder Blue","Purple","Red","Rosy Brown","Royal Blue","Saddle Brown","Salmon","Sandy Brown","Sea Green","Seashell","Sienna","Silver","Sky Blue","Slate Blue","Slate Grey","Snow","Spring Green","Steel Blue","Tan","Teal","Thistle","Tomato","Turquoise","Violet","Wheat","White","White Smoke","Yellow","Yellow Green"],cssNames:null,redComponents:[240,250,0,127,240,245,255,
0,255,0,138,165,222,95,127,210,255,100,255,220,0,0,0,184,169,0,189,139,85,255,153,139,233,143,72,47,0,148,255,0,105,30,178,255,34,255,220,248,255,218,127,0,173,240,255,205,75,255,240,230,255,124,255,173,240,224,250,144,211,255,255,32,135,119,176,255,0,50,250,255,127,102,0,186,147,60,123,0,72,199,25,245,255,255,255,0,253,128,107,255,255,218,238,152,175,219,255,255,205,255,221,176,127,255,188,65,139,250,244,46,255,160,192,135,106,112,255,0,70,210,0,216,255,64,238,245,255,245,255,154],greenComponents:[248,
235,255,255,255,245,228,0,235,0,43,42,184,158,255,105,127,149,248,20,255,0,139,134,169,100,183,0,107,140,50,0,150,188,61,79,206,0,20,191,105,144,34,250,139,0,220,248,215,165,127,127,255,255,105,92,0,255,230,230,240,252,250,216,128,255,250,238,211,182,160,178,206,136,196,255,255,205,240,0,0,205,0,85,112,179,104,250,209,21,25,255,228,228,222,0,245,128,142,165,69,112,232,251,238,112,239,218,133,192,160,224,127,0,143,105,69,128,164,139,245,82,192,206,90,128,250,255,130,180,128,191,99,225,130,222,255,
255,255,205],blueComponents:[255,215,255,212,255,220,196,0,205,255,226,42,135,160,0,30,80,237,220,60,255,139,139,11,169,0,107,139,47,0,204,0,122,143,139,79,209,211,147,255,105,255,34,240,34,255,220,255,0,32,127,127,47,240,180,92,130,240,140,250,245,0,205,230,128,255,210,144,211,193,122,170,250,153,222,224,0,50,230,255,127,170,205,211,219,113,238,154,204,133,112,250,225,181,173,128,230,0,35,0,0,214,170,152,238,147,213,185,63,203,221,230,0,0,143,225,19,114,96,87,238,45,192,235,205,144,250,127,180,140,
128,216,71,208,238,179,255,245,0,50]}};jayus.easing={linear:function(a){return a},easeInQuad:function(a){return a*a},easeOutQuad:function(a){return a*(2-a)},easeInOutQuad:function(a){return((a/=0.5)<1?a*a:(1-a)*(a-3)+1)/2},easeInCubic:function(a){return a*a*a},easeOutCubic:function(a){return--a*a*a+1},easeInOutCubic:function(a){return(a/=0.5)<1?a*a*a/2:(a-=2)*a*a/2+1},easeInQuart:function(a){return a*a*a*a},easeOutQuart:function(a){return--a*a*a*-a+1},easeInOutQuart:function(a){return(a/=0.5)<1?a*a*a*a/2:1-(a-=2)*a*a*a/2},easeInQuint:function(a){return a*
a*a*a*a},easeOutQuint:function(a){return--a*a*a*a*a+1},easeInOutQuint:function(a){return(a/=0.5)<1?a*a*a*a*a/2:(a-=2)*a*a*a*a/2+1},easeInSine:function(a){return 1-Math.cos(a*Math.PI/2)},easeOutSine:function(a){return Math.sin(a*Math.PI/2)},easeInOutSine:function(a){return 0.5-Math.cos(a*Math.PI)/2},easeInExpo:function(a){return(a>0)*Math.pow(2,10*a-10)},easeOutExpo:function(a){return 1-(a!==1)*Math.pow(2,-10*a)},easeInOutExpo:function(a){if(!a||a===1)return a;return(a/=0.5)<1?Math.pow(2,10*a-10)/
2:1-Math.pow(2,10-10*a)/2},easeInCirc:function(a){return 1-Math.sqrt(1-a*a)},easeOutCirc:function(a){return Math.sqrt(--a*-a+1)},easeInOutCirc:function(a){if((a/=0.5)<1)return-(Math.sqrt(1-a*a)-1)/2;return(Math.sqrt(1-(a-=2)*a)+1)/2},easeInElastic:function(a){if(!a||a===1)return a;var b=0.3/(2*Math.PI)*Math.PI/2;return-Math.pow(2,10*--a)*Math.sin((a-b)*2*Math.PI/0.3)},easeOutElastic:function(a){if(!a||a===1)return a;return Math.pow(2,-10*a)*Math.sin((a-0.3/(2*Math.PI)*Math.PI/2)*2*Math.PI/0.3)+1},
easeInOutElastic:function(a){if(!a||a===1)return a;var b=0.3*1.5,c=b/(2*Math.PI)*Math.PI/2;return(a/=0.5)<1?-Math.pow(2,10*--a)*Math.sin((a-c)*2*Math.PI/b)/2:Math.pow(2,-10*--a)*Math.sin((a-c)*2*Math.PI/b)/2+1},easeInBack:function(a){return a*a*(a*2.70158-1.70158)},easeOutBack:function(a){return--a*a*(2.70158*a+1.70158)+1},easeInOutBack:function(a){var b=1.70158;return(a/=0.5)<1?a*a*(((b*=1.525)+1)*a-b)/2:(a-=2)*a*(((b*=1.525)+1)*a+b)/2+1},easeInBounce:function(a){return 1-jayus.easing.easeOutBounce(1-
a)},easeOutBounce:function(a){if(a<1/2.75)return 7.5625*a*a;if(a<2/2.75)return 7.5625*(a-=1.5/2.75)*a+0.75;if(a<2.5/2.75)return 7.5625*(a-=2.25/2.75)*a+0.9375;return 7.5625*(a-=2.625/2.75)*a+0.984375},easeInOutBounce:function(a){return a<0.5?jayus.easing.easeInBounce(a*2)/2:jayus.easing.easeOutBounce(a*2-1)/2+0.5}};jayus.Responder=jayus.createClass({hasHandlers:false,isHandler:null,handlers:null,handle:function(a){for(var b in a)a.hasOwnProperty(b)&&this.addHandler(b,a[b]);return this},addHandler:function(a,b,c){if(!this.hasHandlers){this.hasHandlers=true;this.isHandler={frame:false};this.handlers={}}if(arguments.length===2)c={};c.handler=b;c.hasContext=typeof c.context==="object";c.interceptor=!!c.interceptor;if(this.isHandler[a])this.handlers[a].push(c);else{this.handlers[a]=[c];this.isHandler[a]=true}return this},
interceptNextEvent:function(a,b,c){if(arguments.length===2)c={};c.interceptor=true;return this.addHandler(a,b,c)},removeHandler:function(a,b){if(this.isHandler[a]){if(b instanceof Function)this.handlers[a].splice(this.handlers[a].indexOf(b),1);else{var c,d=b;for(c=0;c<this.handlers[a].length;c++){b=this.handlers[a][c];b.id===d&&this.handlers[a].splice(c,1)}}if(!this.handlers[a].length){delete this.handlers[a];this.isHandler[a]=false}}return this},removeHandlers:function(a){if(this.isHandler[a]){this.handlers[a]=
[];this.isHandler[a]=false}return this},removeAllHandlers:function(){this.hasHandlers=false;typeof this.addDefaultHandlers==="function"&&this.addDefaultHandlers();return this},fire:function(a,b){var c,d,e;if(this.hasHandlers&&this.isHandler[a])for(c=0;c<this.handlers[a].length;c++){d=this.handlers[a][c];e=!!d.handler.call(d.hasContext?d.context:this,b);if(d.interceptor){this.removeHandler(a,d.handler);if(!this.isHandler[a])return e}if(e)return true}return false}});jayus.Animator=jayus.Responder.extend({isAnimator:true,running:false,duration:1E3,startTime:null,easing:jayus.easing.linear,looped:false,oscillate:false,init:function(a){this.update=a},start:function(){if(!this.running){this.startTime=Date.now();this.running=true;jayus.animators.push(this);this.fire("started");this.update(0)}return this},stop:function(){if(this.running){this.running=false;jayus.animators.splice(jayus.animators.indexOf(this),1);this.fire("stopped")}return this},finish:function(){if(this.running){this.running=
false;jayus.animators.splice(jayus.animators.indexOf(this),1);this.update(1);this.fire("finished")}return this},setDuration:function(a){this.duration=a;return this},setEasing:function(a){if(typeof a==="string")a=jayus.easing[a];this.easing=a;return this},tick:function(a){if(a-this.startTime<this.duration){a=this.easing((a-this.startTime)/this.duration);if(a<0)a=0;if(this.oscillate)if(a<=0.5)a*=2;else{a=(a-0.5)*2;a=1-a}this.update(a)}else if(this.looped)this.startTime=Date.now();else this.finish()},
setLooped:function(a){this.looped=a;return this},setOscillate:function(a){this.oscillate=a;return this}});jayus.Animatable=jayus.createClass({actionsToAnimate:0,animate:function(){this.actionsToAnimate++;return this}});
jayus.MethodAnimator=jayus.Animator.extend({target:null,method:null,initialValue:null,finalValue:null,multipleParameters:false,values:null,init:function(a,b,c,d){this.target=a;this.method=b;this.initialValue=c;this.finalValue=d;if(c instanceof Array){this.multipleParameters=true;this.values=[]}},update:function(a){if(this.multipleParameters){for(var b=0;b<this.initialValue.length;b++)this.values[b]=this.initialValue[b]+a*(this.finalValue[b]-this.initialValue[b]);this.method.apply(this.target,this.values)}else this.method.call(this.target,
this.initialValue+a*(this.finalValue-this.initialValue))}});jayus.Animator.Discrete=jayus.Animator.extend({count:NaN,updater:null,init:function(a,b){this.count=a;this.updater=b},update:function(a){a=Math.floor(a*this.count);a===this.count&&a--;this.updater(a)}});jayus.Animator.Sequence=jayus.Animator.extend({animators:null,init:function(){this.animators=new jayus.List},update:function(a){var b=Math.floor(a*counts);b===counts&&b--;a=a*counts-b;this.animators.items[b].update(a)}});jayus.Dependency=jayus.Animatable.extend({dependents:null,dependentCount:0,frozen:0,attach:function(a){if(this.dependentCount)if(this.dependentCount===1)this.dependents=[this.dependents,a];else this.dependents.push(a);else this.dependents=a;this.dependentCount++},detach:function(a){if(this.dependentCount){if(this.dependentCount===1)this.dependents=null;else if(this.dependenCount===2)this.depdendents=this.dependents[1];else this.dependents.splice(this.dependents.indexOf(a),1);this.dependentCount--}},
dirty:function(a){this.frozen||this.informDependents(a)},informDependents:function(a){if(this.dependentCount)if(this.dependentCount===1)this.dependents.componentDirtied(this.componentType,this,a);else for(var b=0;b<this.dependentCount;b++)this.dependents[b].componentDirtied(this.componentType,this,a)},forEachDependent:function(a,b){if(this.dependentCount===1)a.apply(this.dependents,b);else for(var c=0;c<this.dependentCount;c++)a.apply(this.dependents[c],b)}});jayus.List=jayus.createClass({shapeType:-1,parent:null,items:null,init:function(a){if(arguments.length===1)this.parent=a;this.items=[]},added:function(a){this.parent.listItemAdded(this,a)},addedMany:function(a){this.parent.listItemsAdded(this,a)},removed:function(a){this.parent.listItemRemoved(this,a)},removedMany:function(a){this.parent.listItemsRemoved(this,a)},indexOf:function(a){var b;if(typeof a==="string"){for(b=0;b<this.items.length;b++)if(this.items[b].id===a)return b;return-1}return this.items.indexOf(a)},
has:function(a){return this.items.indexOf(a)>=0},count:function(){return this.items.length},at:function(a){if(0<=a&&a<this.items.length)return this.items[a];return null},get:function(a){var b,c;for(b=0;b<this.items.length;b++){c=this.items[b];if(c.id===a)return c}return null},add:function(a){if(arguments.length===1){this.items.push(a);this.added(a)}else{for(var b=0;b<arguments.length;b++)this.items.push(arguments[b]);this.addedMany(arguments)}return this},append:function(a){for(var b=0;b<a.length;b++)this.items.push(a[b]);
this.addedMany(a);return this},insert:function(a,b){this.items.splice(b,0,a);this.added(a);return this},insertBefore:function(a,b){var c=this.items.indexOf(b);if(c>0){this.items.splice(c-1,0,a);this.added(a)}return this},insertAfter:function(a,b){var c=this.items.indexOf(b);if(c!==-1){this.items.splice(c,0,a);this.added(a)}return this},remove:function(a){var b,c;if(arguments.length===1){c=this.items.indexOf(a);if(c>=0){this.items.splice(c,1);this.removed(a)}}else{for(b=0;b<arguments.length;b++){a=
arguments[b];c=this.items.indexOf(a);if(c>=0){this.items.splice(c,1);this.removed(a)}}this.removedMany(arguments)}return this},removeAt:function(a){if(0<=a&&a<this.items.length){var b=this.items[a];this.items.splice(a,1);this.removed(b)}return this},replace:function(a,b){return this.replaceAt(this.indexOf(a),b)},update:function(a,b){var c=this.indexOf(a);c===-1?this.add(b):this.replaceAt(c,b);return this},replaceAt:function(a,b){if(a>=0){this.removed(this.items[a]);this.items[a]=b;this.added(b)}return this},
purge:function(){this.removedMany(this.items);this.items=[];return this},onEach:function(a,b){for(var c=0;c<this.items.length;c++)this.items[c][a].apply(this.items[c],b);return this},forEach:function(a,b){var c,d;for(c=0;c<this.items.length;c++){d=a.apply(this.items[c],b);if(d!==undefined)return d}return null}});jayus.Color=jayus.Dependency.extend({componentType:"COLOR",r:0,g:0,b:0,a:1,init:function(){arguments.length&&this.set.apply(this,arguments)},set:function(a,b,c,d){switch(arguments.length){case 1:b=1;case 2:var e=jayus.colors.displayNames.indexOf(a);if(e<0)e=jayus.colors.cssNames.indexOf(a);e+1&&this.set(jayus.colors.redComponents[e],jayus.colors.greenComponents[e],jayus.colors.blueComponents[e],b);return this;case 3:d=1;case 4:if(this.actionsToAnimate){this.actionsToAnimate--;return new jayus.MethodAnimator(this,
this.set,[this.r,this.g,this.b,this.a],[a,b,c,d])}this.r=a;this.g=b;this.b=c;this.a=d;return this}},setRed:function(a){if(this.actionsToAnimate){this.actionsToAnimate--;return new jayus.MethodAnimator(this,this.setRed,this.r,a)}if(this.r!==a){this.r=a;this.dirty(jayus.DIRTY.STYLE)}return this},setGreen:function(a){if(this.actionsToAnimate){this.actionsToAnimate--;return new jayus.MethodAnimator(this,this.setGreen,this.g,a)}if(this.g!==a){this.g=a;this.dirty(jayus.DIRTY.STYLE)}return this},setBlue:function(a){if(this.actionsToAnimate){this.actionsToAnimate--;
return new jayus.MethodAnimator(this,this.setBlue,this.b,a)}if(this.b!==a){this.b=a;this.dirty(jayus.DIRTY.STYLE)}return this},setAlpha:function(a){if(this.actionsToAnimate){this.actionsToAnimate--;return new jayus.MethodAnimator(this,this.setAlpha,this.a,a)}if(this.a!==a){this.a=a;this.dirty(jayus.DIRTY.STYLE)}return this},toHex:function(){var a=this.r.toString(16),b=this.g.toString(16),c=this.b.toString(16);return"#"+(a.length===1?"0"+a:a)+(b.length===1?"0"+b:b)+(c.length===1?"0"+c:c)},toCSS:function(){this.a=
jayus.math.clamp(0,this.a,1);if(this.a-1)return"rgba("+this.r+","+this.g+","+this.b+","+this.a+")";return"rgb("+this.r+","+this.g+","+this.b+")"},getName:function(){var a,b=jayus.colorTable;for(a=0;a<b.count;a++)if(this.r===b.redComponents[a]&&this.g===b.greenComponents[a]&&this.b===b.blueComponents[a])return b.displayNames[a];return""}});jayus.Brush=jayus.Dependency.extend({componentType:"BRUSH",filling:false,stroking:false,fillType:0,strokeType:0,shadowType:0,alpha:1,strokeFirst:false,fill:null,stroke:null,lineWidth:null,lineCap:null,lineJoin:null,miterLimit:null,lineDash:null,lineDashOffset:null,shadow:null,shadowOffsetX:null,shadowOffsetY:null,shadowBlur:null,init:function(a){arguments.length&&this.apply(a)},componentDirtied:function(){this.dirty(jayus.DIRTY.STYLE)},apply:function(a){this.frozen++;for(var b in a)a.hasOwnProperty(b)&&
this["set"+b[0].toUpperCase()+b.slice(1)](a[b]);this.frozen--;this.dirty(jayus.DIRTY.STYLE);return this},findStyleType:function(a){if(a===null)return 0;if(typeof a==="string")return 1;if(a instanceof CanvasGradient)return 2;if(a instanceof CanvasPattern)return 3;if(a instanceof jayus.Color)return 4;if(a instanceof jayus.LinearGradient)return 5;if(a instanceof jayus.RadialGradient)return 6},getNativeStyle:function(a,b){if(a<=3)return b;if(a===4)return b.toCSS();if(a===5||a===6)return b.getNative()},
applyTo:function(a){if(this.alpha!==1)a.globalAlpha*=this.alpha;if(this.filling)a.fillStyle=this.getNativeStyle(this.fillType,this.fill);if(this.stroking){a.strokeStyle=this.getNativeStyle(this.strokeType,this.stroke);if(this.lineWidth!==null)a.lineWidth=this.lineWidth;if(this.lineCap!==null)a.lineCap=this.lineCap;if(this.lineJoin!==null)a.lineJoin=this.lineJoin;if(this.miterLimit!==null)a.miterLimit=this.miterLimit;if(this.lineDash!==null&&jayus.ua.lineDash){a.setLineDash(this.lineDash);if(this.lineDashOffset!==
null)a.lineDashOffset=this.lineDashOffset}}if(this.shadowType){if(this.shadowType===1)a.shadowColor=this.shadow;else if(this.shadowType===2)a.shadowColor=this.shadow.toCSS();if(this.shadowOffsetX!==null)a.shadowOffsetX=this.shadowOffsetX;if(this.shadowOffsetY!==null)a.shadowOffsetY=this.shadowOffsetY;if(this.shadowBlur!==null)a.shadowBlur=this.shadowBlur}},paintShape:function(a){this.applyTo(a);this.stroking&&this.strokeFirst&&a.stroke();this.filling&&a.fill();this.stroking&&!this.strokeFirst&&a.stroke()},
paintRect:function(a,b,c,d,e){a.save();this.applyTo(a);this.stroking&&this.strokeFirst&&a.strokeRect(b,c,d,e);this.filling&&a.fillRect(b,c,d,e);this.stroking&&!this.strokeFirst&&a.strokeRect(b,c,d,e);a.restore()},setAlpha:function(a){if(a===null)a=1;if(this.alpha!==a){this.alpha=a;this.dirty(jayus.DIRTY.STYLE)}return this},setFill:function(a){this.fillType>=4&&this.fill.detach(this);this.fill=a;this.fillType=this.findStyleType(a);this.fillType>=4&&this.fill.attach(this);this.filling=!!this.fillType;
this.dirty(jayus.DIRTY.STYLE);return this},setStroke:function(a){this.strokeType>=4&&this.stroke.detach(this);this.stroke=a;this.strokeType=this.findStyleType(a);this.strokeType>=4&&this.stroke.attach(this);this.stroking=!!this.strokeType;this.dirty(jayus.DIRTY.STYLE);return this},setLineWidth:function(a){if(this.lineWidth!==a){this.lineWidth=a;this.dirty(jayus.DIRTY.STYLE)}return this},setLineCap:function(a){if(this.lineCap!==a){this.lineCap=a;this.dirty(jayus.DIRTY.STYLE)}return this},setLineJoin:function(a){if(this.lineJoin!==
a){this.lineJoin=a;this.dirty(jayus.DIRTY.STYLE)}return this},setMiterLimit:function(a){if(this.miterLimit!==a){this.miterLimit=a;this.dirty(jayus.DIRTY.STYLE)}return this},setLineDash:function(a){this.lineDash=a;this.dirty(jayus.DIRTY.STYLE);return this},setLineDashOffset:function(a){if(this.lineDashOffset!==a){this.lineDashOffset=a;this.dirty(jayus.DIRTY.STYLE)}return this},setShadow:function(a){this.shadowType===2&&this.shadow.detach(this);this.shadow=a;if(a===null)this.shadowType=0;else if(typeof a===
"string")this.shadowType=1;else if(a instanceof jayus.Color){this.shadowType=2;this.shadow.attach(this)}this.dirty(jayus.DIRTY.STYLE);return this},setShadowOffsetX:function(a){if(this.shadowOffsetX!==a){this.shadowOffsetX=a;this.dirty(jayus.DIRTY.STYLE)}return this},setShadowOffsetY:function(a){if(this.shadowOffsetY!==a){this.shadowOffsetY=a;this.dirty(jayus.DIRTY.STYLE)}return this},setShadowBlur:function(a){if(this.shadowBlur!==a){this.shadowBlur=a;this.dirty(jayus.DIRTY.STYLE)}return this}});jayus.Gradient=jayus.Dependency.extend({componentType:"GRADIENT",stopPositions:null,stopColors:null,nativeGradient:null,reformNative:true,componentDirtied:function(){this.reformNative=true;this.dirty(jayus.DIRTY.STYLE)},translate:function(a,b){if(arguments.length===1){b=a.y;a=a.x}this.start.translate(a,b);this.end.translate(a,b);this.dirty(jayus.DIRTY.ALL);return this},addColorStop:function(a,b){this.stopPositions.push(a);this.stopColors.push(b);return this},getNative:function(){if(this.reformNative){this.refresh();
this.reformNative=false}return this.nativeGradient}});
jayus.LinearGradient=jayus.Gradient.extend({start:null,end:null,init:overloadArgumentCount({2:function(a,b){this.stopPositions=[];this.stopColors=[];this.start=a;this.start.attach(this);this.end=b;this.end.attach(this)},4:function(a,b,c,d){this.init(new jayus.Point(a,b),new jayus.Point(c,d))}}),refresh:function(){var a,b;this.nativeGradient=jayus.getContext().createLinearGradient(this.start.x,this.start.y,this.end.x,this.end.y);for(a=0;a<this.stopPositions.length;a++){b=this.stopColors[a];if(b instanceof
jayus.Color)b=b.toCSS();this.nativeGradient.addColorStop(this.stopPositions[a],b)}return this}});
jayus.RadialGradient=jayus.Gradient.extend({start:null,end:null,init:overloadArgumentCount({2:function(a,b){this.stopPositions=[];this.stopColors=[];this.start=a;this.start.attach(this);this.end=b;this.end.attach(this)},4:function(a,b,c,d){this.init(new jayus.Circle(a,b),new jayus.Circle(c,d))},6:function(a,b,c,d,e,f){this.init(new jayus.Circle(a,b,c),new jayus.Circle(d,e,f))}}),refresh:function(){var a,b;this.nativeGradient=jayus.getContext().createRadialGradient(this.start.x,this.start.y,this.start.radius,
this.end.x,this.end.y,this.end.radius);for(a=0;a<this.stopPositions.length;a++){b=this.stopColors[a];if(b instanceof jayus.Color)b=b.toCSS();this.nativeGradient.addColorStop(this.stopPositions[a],b)}return this}});jayus.Matrix=jayus.createClass({a:1,b:0,tx:0,c:0,d:1,ty:0,init:function(a,b,c,d,e,f){if(arguments.length){this.a=a;this.b=b;this.tx=c;this.c=d;this.d=e;this.ty=f}},translate:function(a,b){if(arguments.length===1){b=a.y;a=a.x}this.tx+=this.a*a+this.b*b;this.ty+=this.d*b+this.c*a;return this},scale:function(a,b){if(arguments.length===1){b=a.y;a=a.x}this.a*=a;this.c*=a;this.d*=b;this.b*=b;return this},rotate:function(a){var b=Math.sin(a);a=Math.cos(a);var c=this.a*a+this.b*b;this.b=-this.a*b+this.b*
a;this.a=c;c=this.d*b+this.c*a;this.d=this.d*a-this.c*b;this.c=c;return this},multiply:function(a){m2=this;return new jayus.Matrix(a.a*m2.a+a.b*m2.c,a.a*m2.b+a.b*m2.d,a.a*m2.tx+a.b*m2.ty+a.tx,a.c*m2.a+a.d*m2.c,a.c*m2.b+a.d*m2.d,a.c*m2.tx+a.d*m2.ty+a.ty)},transformPoint:function(a,b){if(arguments.length===1){b=a.y;a=a.x}return this.transformPointOnto(a,b,new jayus.Point)},transformPointOnto:function(a,b,c){c.x=a*this.a+b*this.b+this.tx;c.y=a*this.c+b*this.d+this.ty;return c},inverseTransformPoint:function(a,
b){if(arguments.length===1){b=a.y;a=a.x}return this.inverseTransformPointOnto(a,b,new jayus.Point)},inverseTransformPointOnto:function(a,b,c){var d=this.getDeterminant();if(d){a-=this.tx;b-=this.ty;c.x=(a*this.d-b*this.b)/d;c.y=(b*this.a-a*this.c)/d;return c}return null},identity:function(){this.a=this.d=1;this.b=this.tx=this.c=this.ty=0;return this},getDeterminant:function(){var a=this.a*this.d-this.b*this.c;if(isFinite(a)&&Math.abs(a)>1.0E-11&&isFinite(this.tx)&&isFinite(this.ty))return a;return null},
clone:function(){return this.cloneOnto(new jayus.Matrix)},cloneOnto:function(a){a.init(this.a,this.b,this.tx,this.c,this.d,this.ty);return a},equals:function(a){return this.a===a.a&&this.b===a.b&&this.c===a.c&&this.d===a.d&&this.tx===a.tx&&this.ty===a.ty},applyToContext:function(a){a.transform(this.a,this.c,this.b,this.d,this.tx,this.ty)}});jayus.SizePolicy=jayus.createClass({size:0,weight:1,expand:true});jayus.images={images:{},pendingImageCount:0,has:function(a){return typeof this.images[a]==="object"},isLoaded:function(a){return typeof this.images[a]==="object"&&(this.images[a].loaded||this.images[a].tagName==="CANVAS")},get:function(a){this.has(a)||this.load(a);return this.images[a]},setSubimage:function(a,b,c,d,e,f){a=this.get(a);var h=document.createElement("canvas");h.width=e;h.height=f;h.getContext("2d").drawImage(a,c,d,e,f,0,0,e,f);this.images[b]=h;return this},load:function(a,b){if(!this.has(a)){var c=
new Image;c.isSheet=false;c.loaded=false;this.images[a]=c;c.onload=function(){this.loaded=true;jayus.fire("imageLoaded",{filepath:a,image:this});jayus.images.pendingImageCount--;jayus.images.pendingImageCount||jayus.fire("imagesLoaded");typeof b==="function"&&b(a,this)};this.pendingImageCount++;c.src=a}},loadAll:function(a,b){var c,d,e;if(arguments.length===1)for(c=0;c<a.length;c++)this.load(a[c]);else if(arguments.length===2){d=a.length;e=function(){d--;d||b()};for(c=0;c<a.length;c++)this.load(a[c],
e)}}};jayus.objects={objects:{},pendingObjectCount:0,has:function(a){return typeof this.objects[a]==="object"&&this.objects[a]!==null},get:function(a){this.has(a)||this.load(a);return this.objects[a]},load:function(a,b){if(this.has(a))arguments.length===2&&b(a,this.objects[a]);else{var c=new XMLHttpRequest;c.filepath=a;c.open("get",a,true);c.onload=function(){var d=JSON.parse(this.responseText);jayus.objects.objects[this.filepath]=d;typeof b==="function"&&b(this.filepath,d,this);jayus.fire("objectLoaded",
{filepath:this.filepath,object:d,xhr:this});jayus.objects.pendingObjectCount--;jayus.objects.pendingObjectCount||jayus.fire("objectsLoaded")};this.objects[a]=null;this.pendingObjectCount++;c.send()}},loadAll:function(a,b){var c,d,e;if(arguments.length===1)for(c=0;c<a.length;c++)this.load(a[c]);else if(arguments.length===2){d=a.length;e=function(){d--;d||b()};for(c=0;c<a.length;c++)this.load(a[c],e)}}};jayus.keyboard={requireFocus:true,pressed:{},keys:[0,0,0,0,0,0,0,0,"backspace","tab",0,0,0,"enter",0,0,"shift","ctrl","alt","break","capsLock",0,0,0,0,0,0,"escape",0,0,0,0,"space","pageUp","pageDown","end","home","left","up","right","down",0,0,0,0,"insert","delete",0,"0","1","2","3","4","5","6","7","8","9",0,0,0,0,0,0,0,"a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","leftWin","rightWin","select",0,0,"num0","num1","num2","num3","num4","num5",
"num6","num7","num8","num9","numMultiply","numAdd",0,"numSubtract","numPeriod","numDivide","f1","f2","f3","f4","f5","f6","f7","f8","f9","f10","f11","f12",0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,"numLock","scrollLock",0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,"semicolon","equalSign","comma","dash","period","forwardSlash","grave",0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,"leftBracket","backslash","rightBracket","quote"],keyPressEventData:{},charTypeEventData:{},
init:function(){document.addEventListener("keydown",function(a){if(jayus.keyboard.requireFocus&&jayus.hasFocus){var b=jayus.keyboard.keys[a.keyCode],c=jayus.keyboard.keyPressEventData;c.event=a;c.key=b;if(jayus.keyboard.pressed[b])return!jayus.fire("keyTap",c);jayus.keyboard.pressed[b]=true;if(jayus.fire("keyPress",c)||jayus.fire("keyTap",c)){a.preventDefault();return false}}});document.addEventListener("keyup",function(a){var b=jayus.keyboard.keys[a.keyCode],c=jayus.keyboard.keyPressEventData;c.event=
a;c.key=b;if(jayus.keyboard.pressed[b]){jayus.keyboard.pressed[b]=false;if(jayus.fire("keyRelease",c)){a.preventDefault();return false}}});document.addEventListener("keypress",function(a){if(jayus.keyboard.requireFocus&&jayus.hasFocus){var b=jayus.keyboard.charTypeEventData;b.event=a;b["char"]=String.fromCharCode(a.charCode);if(jayus.fire("charType",b)){a.preventDefault();return false}}})},isPressed:function(a){return!!this.pressed[a]},isKey:function(a){return this.keys.indexOf(a)>=0}};jayus.Shape=jayus.Dependency.extend({paintedWith:function(a){return new jayus.PaintedShape(this,a)}});jayus.Point=jayus.Dependency.extend({componentType:"POINT",x:0,y:0,init:function(a,b){if(arguments.length){this.x=a;this.y=b}},setX:function(a){if(this.actionsToAnimate){this.actionsToAnimate--;return new jayus.MethodAnimator(this,this.setX,this.x,a)}if(this.x!==a){this.x=a;this.dirty(2)}return this},setY:function(a){if(this.actionsToAnimate){this.actionsToAnimate--;return new jayus.MethodAnimator(this,this.setY,this.y,a)}if(this.y!==a){this.y=a;this.dirty(2)}return this},set:function(a,b){if(arguments.length===
1){b=a.y;a=a.x}if(this.actionsToAnimate){this.actionsToAnimate--;return new jayus.MethodAnimator(this,this.set,[this.x,this.y],[a,b])}if(this.x!==a||this.y!==b){this.x=a;this.y=b;this.dirty(2)}return this},translate:function(a,b){if(arguments.length===1){b=a.y;a=a.x}return this.set(this.x+a,this.y+b)},clone:function(){return new jayus.Point(this.x,this.y)},equals:function(a,b){if(arguments.length===1){b=a.y;a=a.x}return this.x===a&&this.y===b}});jayus.Rectangle=jayus.Shape.extend({componentType:"RECTANGLE",shapeType:4,x:0,y:0,width:0,height:0,keepAligned:true,init:function(a,b,c,d){if(arguments.length){if(arguments.length===2){d=b.height;c=b.width;b=a.y;a=a.x}else if(arguments.length===3){c=d=c;b=a.y;a=a.x}this.x=a;this.y=b;this.width=c;this.height=d}},getOrigin:function(){return new jayus.Point(this.x,this.y)},getOriginOnto:function(a){a.x=this.x;a.y=this.y;return a},setX:jayus.Point.prototype.setX,setY:jayus.Point.prototype.setY,setOrigin:function(a,
b){if(arguments.length===1){b=a.y;a=a.x}if(this.actionsToAnimate){this.actionsToAnimate--;return new jayus.MethodAnimator(this,this.setOrigin,[this.x,this.y],[a,b])}if(this.x!==a||this.y!==b){this.x=a;this.y=b;this.dirty(2)}return this},translate:function(a,b){if(arguments.length===1){b=a.y;a=a.x}return this.setOrigin(this.x+a,this.y+b)},setWidth:function(a){if(this.actionsToAnimate){this.actionsToAnimate--;return new jayus.MethodAnimator(this,this.setWidth,this.width,a)}if(this.width!==a){this.width=
a;this.dirty(4)}return this},setHeight:function(a){if(this.actionsToAnimate){this.actionsToAnimate--;return new jayus.MethodAnimator(this,this.setHeight,this.height,a)}if(this.height!==a){this.height=a;this.dirty(4)}return this},setSize:function(a,b){if(arguments.length===1){b=a.height;a=a.width}if(this.actionsToAnimate){this.actionsToAnimate--;return new jayus.MethodAnimator(this,this.setSize,[this.width,this.height],[a,b])}if(this.width!==a||this.height!==b){this.width=a;this.height=b;this.dirty(4)}return this},
expand:function(a,b){return this.setSize(this.width+a,this.height+b)},getLeft:function(){return this.x},getRight:function(){return this.x+this.width},getTop:function(){return this.y},getBottom:function(){return this.y+this.height},setLeft:function(a){return this.setFrame(a,this.y,this.x+this.width-a,this.height)},setRight:function(a){return this.setWidth(this.width+a-this.x)},setTop:function(a){return this.setFrame(this.x,a,this.width,this.y+this.height-a)},setBottom:function(a){return this.setHeight(this.height+
a-this.y)},setFrame:function(a,b,c,d){if(arguments.length===3){d=c;c=b;b=a.y;a=a.x}if(this.actionsToAnimate){this.actionsToAnimate--;return new jayus.MethodAnimator(this,this.setFrame,[this.x,this.y,this.width,this.height],[a,b,c,d])}this.frozen++;this.setOrigin(a,b).setSize(c,d);this.frozen--;this.dirty(jayus.DIRTY.FRAME);return this},includePoint:function(a,b){if(arguments.length===1){b=a.y;a=a.x}var c=Math.min(this.x,a),d=Math.min(this.y,b);return this.setFrame(c,d,Math.max(this.x+this.width,a)-
c,Math.max(this.y+this.height,b)-d)},includeRectangle:function(a,b,c,d){if(arguments.length===1){d=a.height;c=a.width;b=a.y;a=a.x}else if(arguments.length===3){d=c;c=b;b=a.y;a=a.x}var e=Math.min(this.x,a),f=Math.min(this.y,b);return this.setFrame(e,f,Math.max(this.x+this.width,a+c)-e,Math.max(this.y+this.height,b+d)-f)},alignToCanvas:function(){return this.setFrame(Math.floor(this.x)+0.5,Math.floor(this.y)+0.5,Math.round(this.width),Math.round(this.height))},intersectsAt:function(a,b){return this.x<=
a&&a<=this.x+this.width&&this.y<=b&&b<=this.y+this.height},getScope:function(){return this.clone()},getTransformed:function(a){return this.toPolygon().getTransformed(a)},clone:function(){return this.cloneOnto(new jayus.Rectangle)},cloneOnto:function(a){a.x=this.x;a.y=this.y;a.width=this.width;a.height=this.height;return a},toPolygon:function(){return new jayus.Polygon.Rectangle(this.x,this.y,this.width,this.height)},etchOntoContext:function(a){a.beginPath();this.keepAligned?a.rect(Math.round(this.x)+
0.5,Math.round(this.y)+0.5,Math.round(this.width),Math.round(this.height)):a.rect(this.x,this.y,this.width,this.height);return this}});jayus.Circle=jayus.Shape.extend({shapeType:2,componentType:"CIRCLE",x:0,y:0,radius:1,init:function(a,b,c){if(arguments.length){if(arguments.length===2){c=b;b=a.y;a=a.x}this.x=a;this.y=b;this.radius=c}},pointChanged:function(){},getCenter:function(){return new jayus.Point(this.x,this.y)},setX:jayus.Point.prototype.setX,setY:jayus.Point.prototype.setY,setCenter:jayus.Point.prototype.set,translate:function(a,b){if(arguments.length===1){b=a.y;a=a.x}return this.setCenter(this.x+a,this.y+b)},alignToCanvas:function(){return this},
getRadius:function(){return this.radius},setRadius:function(a){if(this.actionsToAnimate){this.actionsToAnimate--;return new jayus.MethodAnimator(this,this.setRadius,this.radius,a)}if(this.radius!==a){this.radius=a;this.dirty(4)}return this},intersectsAt:function(a,b){return(this.x-a)*(this.x-a)+(this.y-b)*(this.y-b)<=this.radius*this.radius},getScope:function(){return new jayus.Rectangle(this.x-this.radius,this.y-this.radius,this.radius*2,this.radius*2)},clone:function(){return new jayus.Circle(this.x,
this.y,this.radius)},cloneOnto:function(a){a.x=this.x;a.y=this.y;a.radius=this.radius;return a},etchOntoContext:function(a){a.beginPath();a.arc(this.x,this.y,this.radius,0,Math.PI*2)}});jayus.Polygon=jayus.Shape.extend({componentType:"POLYGON",shapeType:8,xPoints:null,yPoints:null,x1:0,y1:0,x2:0,y2:0,closed:true,frame:null,frameDirty:true,init:function(a,b){if(arguments.length===1){this.xPoints=[];this.yPoints=[];for(var c=0;c<a.length;c++){this.xPoints[c]=a[c].x;this.yPoints[c]=a[c].y}}else if(arguments.length===2){this.xPoints=a;this.yPoints=b}},translate:function(a,b){if(arguments.length===1){b=a.y;a=a.x}if(a||b){for(var c=0;c<this.xPoints.length;c++){this.xPoints[c]+=a;this.yPoints[c]+=
b}this.frameDirty=true}return this},alignToCanvas:function(){return this},addPoint:function(a,b){if(arguments.length===1){b=a.y;a=a.x}this.xPoints.push(a);this.yPoints.push(b);this.frameDirty=true;this.dirty(16);return this},addPoints:function(a,b){if(arguments.length===1)for(var c=0;c<a.length;c++){this.xPoints.push(a[c].x);this.yPoints.push(a[c].y)}else if(arguments.length===2){this.xPoints=this.xPoints.concat(a);this.yPoints=this.yPoints.concat(b)}this.frameDirty=true;this.dirty(16);return this},
insertPoint:function(a,b,c){if(arguments.length===2){c=b.y;b=b.x}this.xPoints.splice(a,0,b);this.yPoints.splice(a,0,c);this.frameDirty=true;this.dirty(16);return this},setPoint:function(a,b,c){if(arguments.length===2){c=b.y;b=b.x}this.xPoints[a]=b;this.yPoints[a]=c;this.frameDirty=true;this.dirty(16);return this},getLeft:function(){return this.getFrame().getLeft()},getTop:function(){return this.getFrame().getTop()},getWidth:function(){return this.getFrame().getWidth()},getHeight:function(){return this.getFrame().getHeight()},
getScope:function(){return this.getFrame()},getFrame:function(){if(this.frameDirty){this.reformFrame();this.frameDirty=false}return this.frame},reformFrame:function(){var a,b,c,d=null,e=null,f=null,h=null;for(a=0;a<this.xPoints.length;a++){b=this.xPoints[a];c=this.yPoints[a];if(d===null||b<d)d=b;if(e===null||b>e)e=b;if(f===null||c<f)f=c;if(h===null||c>h)h=c}if(this.frame===null)this.frame=new jayus.Rectangle;this.frame.setFrame(d,f,e-d,h-f)},intersectsAt:function(a,b){var c=jayus.getContext();c.save();
this.etchOntoContext(c);var d=c.isPointInPath(a,b);c.restore();return d},setClosed:function(a){if(this.closed!==a){this.closed=a;this.dirty(16)}return this},clone:function(){return new jayus.Polygon(this.xPoints.slice(0),this.yPoints.slice(0))},cloneOnto:function(a){a.xPoints=this.xPoints.slice(0);a.yPoints=this.yPoints.slice(0);a.frameDirty=true;return a},transform:function(a){var b,c=new jayus.Point;for(b=0;b<this.xPoints.length;b++){a.transformPointOnto(this.xPoints[b],this.yPoints[b],c);this.xPoints[b]=
c.x;this.yPoints[b]=c.y}this.frameDirty=true;return this},getTransformed:function(a){return this.getTransformedOnto(a,new jayus.Polygon)},getTransformedOnto:function(a,b){var c,d=new jayus.Point;for(c=0;c<this.xPoints.length;c++){a.transformPointOnto(this.xPoints[c],this.yPoints[c],d);b.xPoints.push(d.x);b.yPoints.push(d.y)}return b},etchOntoContext:function(a){if(this.xPoints.length){a.beginPath();a.moveTo(this.xPoints[0],this.yPoints[0]);for(var b=0;b<this.xPoints.length;b++)a.lineTo(this.xPoints[b],
this.yPoints[b]);this.closed&&a.closePath()}return this}});jayus.Polygon.Line=function(a,b,c,d){if(arguments.length===2){d=b.y;c=b.x;b=a.y;a=a.x}return new jayus.Polygon([a,c],[b,d])};jayus.Polygon.LineOnto=function(a,b,c,d,e){e.xPoints=[a,c];e.yPoints=[b,d];e.frameDirty=true;return e};jayus.Polygon.Rectangle=function(a,b,c,d){if(arguments.length===3){d=c;c=b;b=a.y;a=a.x}return new jayus.Polygon([a,a+c,a+c,a],[b,b,b+d,b+d])};
jayus.Polygon.Regular=function(a,b){var c,d=new jayus.Polygon,e=0,f=Math.PI*2/a;for(c=0;c<a;c++){d.addPoint(b*Math.cos(e),b*Math.sin(e));e+=f}return d};jayus.Polygon.Star=function(a,b,c){var d,e=new jayus.Polygon,f=0,h=Math.PI/a,g=true,i=b;for(d=0;d<a*2;d++){e.addPoint(i*Math.cos(f),i*Math.sin(f));i+=g?c:b;g=!g;f+=h}return e};jayus.Path=jayus.Shape.extend({shapeType:16,segments:null,x1:0,y1:0,x2:0,y2:0,frame:null,frameDirty:true,init:function(a){this.segments=[];arguments.length&&this.addSVS(a)},translate:function(a,b){if(arguments.length===1){b=a.y;a=a.x}for(var c=0;c<this.segments.length;c++)this.moveSegment(c,a,b);return this},alignToCanvas:function(){return this},getScope:function(){if(this.segments.length===0)return null;this.reformFrame();return new jayus.Rectangle(this.x1,this.y1,this.x2-this.x1,this.y2-this.y1)},
reformFrame:function(){var a,b,c,d=null,e=null,f=null,h=null;for(a=0;a<this.segments.length;a++){c=this.getPoint(a);b=c.x;c=c.y;if(d===null||b<d)d=b;if(e===null||b>e)e=b;if(f===null||c<f)f=c;if(h===null||c>h)h=c}this.x1=d;this.x2=e;this.y1=f;this.y2=h},intersectsAt:function(a,b){var c=jayus.getContext();c.save();this.etchOntoContext(c);var d=c.isPointInPath(a,b);c.restore();return d},moveTo:function(a,b){return this.addSegment(["moveTo",a,b])},moveBy:function(a,b){var c=this.getCurrentPoint();return this.moveTo(c.x+
a,c.y+b)},closePath:function(){return this.addSegment(["closePath"])},lineTo:function(a,b){return this.addSegment(["lineTo",a,b])},lineBy:function(a,b){var c=this.getCurrentPoint();return this.lineTo(c.x+a,c.y+b)},quadraticCurveTo:function(a,b,c,d){return this.addSegment(["quadraticCurveTo",a,b,c,d])},quadraticCurveBy:function(a,b,c,d){var e=this.getCurrentPoint();return this.quadraticCurveTo(e.x+a,e.y+b,e.x+c,e.y+d)},bezierCurveTo:function(a,b,c,d,e,f){return this.addSegment(["bezierCurveTo",a,b,
c,d,e,f])},bezierCurveBy:function(a,b,c,d,e,f){var h=this.getCurrentPoint();return this.bezierCurveTo(h.x+a,h.y+b,h.x+c,h.y+d,h.x+e,h.y+f)},arcTo:function(a,b,c,d,e){return this.addSegment(["arcTo",a,b,c,d,e])},arcBy:function(a,b,c,d,e){var f=this.getCurrentPoint();return this.arcTo(f.x+a,f.y+b,f.x+c,f.y+d,e)},arc:function(a,b,c,d,e,f){return this.addSegment(["arc",a,b,c,d,e,f])},rect:function(a,b,c,d){return this.addSegment(["rect",a,b,c,d])},ellipse:function(a,b,c,d,e,f,h,g){return this.addSegment(["ellipse",
a,b,c,d,f,h,g])},horizontalLineTo:function(a){return this.lineTo(a,this.getCurrentPoint().y)},horizontalLineBy:function(a){return this.lineBy(a,0)},verticalLineTo:function(a){return this.lineTo(this.getCurrentPoint().x,a)},verticalLineBy:function(a){return this.lineBy(0,a)},addSegment:function(a){this.segments.push(a);return this},getInitialPoint:function(){return this.getPoint(0)},getCurrentPoint:function(){return this.getPoint(this.segments.length-1)},getPoint:function(a){if(this.hasPointIndex(a)){var b=
this.segments[a];switch(b[0]){case "moveTo":return new jayus.Point(b[1],b[2]);case "closePath":return this.getInitialPoint();case "lineTo":return new jayus.Point(b[1],b[2]);case "quadraticCurveTo":return new jayus.Point(b[3],b[4]);case "bezierCurveTo":return new jayus.Point(b[5],b[6]);case "arcTo":return jayus.getFinalArcToPoint(this,b);case "arc":a=b[3];var c=b[5];return new jayus.Point(b[1]+a*Math.cos(c),b[2]+a*Math.sin(c));case "rect":return this.getPoint(a-1);case "ellipse":throw Error('Path.getPoint() - Unimplemented for "ellipse"');
}}else throw new RangeError("Path.getPoint() - Invalid index sent: "+a);},addSVG:function(a){var b,c=this.parsePathString(a);for(a=0;a<c.length;a++){b=c[a];switch(b[0]){case "M":this.moveTo(b[1],b[2]);break;case "m":this.moveBy(b[1],b[2]);break;case "Z":case "z":this.closePath();break;case "L":this.lineTo(b[1],b[2]);break;case "l":this.lineBy(b[1],b[2]);break;case "H":this.horizontalLineTo(b[1]);break;case "h":this.horizontalLineBy(b[1]);break;case "V":this.verticalLineTo(b[1]);break;case "v":this.verticalLineBy(b[1]);
break;case "C":this.bezierCurveTo(b[1],b[2],b[3],b[4],b[5],b[6]);break;case "c":this.bezierCurveBy(b[1],b[2],b[3],b[4],b[5],b[6]);break;case "S":case "s":throw Error("Path.addSVG() - Unimplemented for S/s commands");case "Q":this.quadraticCurveTo(b[1],b[2],b[3],b[4]);break;case "q":this.quadraticCurveBy(b[1],b[2],b[3],b[4]);break;case "T":case "t":throw Error("Path.addSVG() - Unimplemented for T/t commands");case "A":case "a":throw Error("Path.addSVG() - Unimplemented for A/a commands");case "R":case "r":throw Error("Path.addSVG() - Unimplemented for R/r commands");
}}},parsePathString:function(a){a=a.replace(/ /g,",").replace(/-/g,",-");a=a.replace(/[MmZzLlHhVvCcSsQqTtAaRr]/g,function(i){return","+i+","});a=a.split(",");var b,c,d={a:7,c:6,h:1,l:2,m:2,r:4,q:4,s:4,t:2,v:1,z:0},e,f=[],h=0;for(b=0;b<a.length;b++){c=a[b];if(c!=="")if(h===0)if(d.hasOwnProperty(c.toLowerCase())){e=[c];h=d[c.toLowerCase()];f.push(e)}else return"ERROR: expected command, got: "+c;else{var g=parseFloat(c);if(isNaN(g))return"ERROR: expected parameter, got: "+c;else{e.push(g);h--}}}return f},
getSegmentCount:function(){return this.segments.length},hasPointIndex:function(a){return 0<=a&&a<this.segments.length},isClosed:function(){return this.getInitialPoint().equals(this.getCurrentPoint())},clone:function(){var a,b,c,d,e=[];for(a=0;a<this.segments.length;a++){c=this.segments[a];d=[];for(b=0;b<c.length;b++)d.push(c[b]);e.push(d)}a=new jayus.Path;a.segments=e;return a},getTransformed:function(a){var b,c,d,e,f=[];for(b=0;b<this.segments.length;b++){c=this.segments[b];d=[c[0]];f.push(d);switch(c[0]){case "moveTo":e=
a.transformPoint(c[1],c[2]);d[1]=e.x;d[2]=e.y;break;case "lineTo":e=a.transformPoint(c[1],c[2]);d[1]=e.x;d[2]=e.y;break;case "quadraticCurveTo":e=a.transformPoint(c[1],c[2]);d[1]=e.x;d[2]=e.y;e=a.transformPoint(c[3],c[4]);d[3]=e.x;d[4]=e.y;break;case "bezierCurveTo":e=a.transformPoint(c[1],c[2]);d[1]=e.x;d[2]=e.y;e=a.transformPoint(c[3],c[4]);d[3]=e.x;d[4]=e.y;e=a.transformPoint(c[5],c[6]);d[5]=e.x;d[6]=e.y;break;case "arcTo":case "arc":case "rect":case "ellipse":throw Error("Path.getTransformed() - Unimplemented for command "+
c[0]);}}},etchOntoContext:function(a){a.beginPath();var b,c;b=this.getPoint(0);var d=b.x,e=b.y;for(b=0;b<this.segments.length;b++){c=this.segments[b];switch(c[0]){case "moveTo":d=c[1];e=c[2];a.moveTo(d,e);break;case "closePath":a.closePath();break;case "lineTo":d=c[1];e=c[2];a.lineTo(d,e);break;case "bezierCurveTo":d=c[5];e=c[6];a.bezierCurveTo(c[1],c[2],c[3],c[4],d,e);break;case "quadraticCurveTo":d=c[3];e=c[4];a.quadraticCurveTo(c[1],c[2],d,e);break;case "arcTo":a.arcTo(c[1],c[2],c[3],c[4],c[5]);
this.getPoint(b);break;case "arc":a.arc(c[1],c[2],c[3],c[4],c[5],c[6]);this.getPoint(b);break;case "rect":d=c[1];e=c[2];a.rect(d,e,c[3],c[4]);break;case "ellipse":throw Error("Path.etchOntoContext() - Unimplemented for command ellipse");}}return this}});jayus.Path.Circle=function(a,b,c){if(arguments.length===2){c=a;b=a.y;a=a.x}return(new jayus.Path).arc(a,b,c,0,Math.PI*2,false)};jayus.Path.Rectangle=function(a,b,c,d){if(arguments.length===3){d=c;c=b;b=a.y;a=a.x}return(new jayus.Path).rect(a,b,c,d)};
jayus.getFinalArcToPoint=function(a,b){var c=a.getPoint(b-1),d=b[1],e=b[2],f=Math.atan2(e-b[4],d-b[3]);c=Math.abs(Math.atan2(c.y-e,c.x-d)-f);c=b[5]/Math.tan(Math.min(Math.PI*2-c,c)/2);return new jayus.Point(d+c*Math.cos(f),e+c*Math.sin(f))};
jayus.getPathScope=function(a){var b,c,d=new jayus.Rectangle;for(b=0;b<a.segments.length;b++){c=a.segments[b];switch(c[0]){case "moveTo":d.includeAt(c[1],c[2]);break;case "lineTo":d.includeAt(c[1],c[2]);break;case "bezierCurveTo":d.includeAt(c[1],c[2]);d.includeAt(c[3],c[4]);d.includeAt(c[5],c[6]);break;case "quadraticCurveTo":d.includeAt(c[1],c[2]);d.includeAt(c[3],c[4]);break;case "rect":var e=c[1],f=c[2],h=c[3];c=c[4];d.setLeft(Math.max(d.getLeft(),e));d.setRight(Math.max(d.getRight(),e+h));d.setTop(Math.max(d.getTop(),
f));d.setBottom(Math.max(d.getBottom(),f+c))}}};jayus.applyObject(jayus.Dependency.prototype,jayus.Responder.prototype);
jayus.Entity=jayus.Responder.extend({componentType:"ENTITY",shapeType:0,isEntity:true,isRect:false,isParent:false,id:"",visible:true,alpha:1,dirtied:true,frozen:0,hasParent:false,parent:null,angle:0,xScale:1,yScale:1,xAnchor:0,yAnchor:0,trackCursor:true,canAcceptCursor:false,canReleaseCursor:true,underCursor:false,hasCursor:false,draggable:false,dragButton:"left",dragging:false,enableDragEvents:true,leftDragging:false,middleDragging:false,rightDragging:false,isTransformed:false,transforms:null,init:function(){this.enableDragEvents&&
this.handle({leftPress:function(a){this.leftDragging=true;return this.fire("leftDragStart",a)},leftRelease:function(a){if(this.leftDragging){this.leftDragging=false;return this.fire("leftDragEnd",a)}},middlePress:function(a){this.middleDragging=true;return this.fire("middleDragStart",a)},middleRelease:function(a){if(this.middleDragging){this.middleDragging=false;return this.fire("middleDragEnd",a)}},rightPress:function(a){this.rightDragging=true;return this.fire("rightDragStart",a)},rightRelease:function(a){if(this.rightDragging){this.rightDragging=
false;return this.fire("rightDragEnd",a)}},cursorMove:function(a){var b=false;if(this.leftDragging)b=this.fire("leftDrag",a)||b;if(this.middleDragging)b=this.fire("middleDrag",a)||b;if(this.rightDragging)b=this.fire("rightDrag",a)||b;return b},cursorOut:function(){this.leftDragging&&this.fire("leftDragEnd");this.middleDragging&&this.fire("middleDragEnd");this.rightDragging&&this.fire("rightDragEnd");this.leftDragging=this.middleDragging=this.rightDragging=false}})},setId:function(a){this.id=a;return this},
dirty:function(a){if(typeof a!=="number")throw Error("Entity.dirty() - No type specified");if(!this.frozen){if(a&2){this.matrixDirty=true;this.fire("moved")}this.dirtied=true;this.informDependents(a)}return this},getAbsoluteParent:function(){return this.hasParent?this.parent.getAbsoluteParent():this},setParent:function(a){this.hasParent=true;this.parent=a;this.attach(a);this.fire("added")},removeParent:function(){this.hasParent=false;this.parent=null;this.underCursor=false;this.detach(parent);this.fire("removed")},
setVisible:function(a){if(this.visible!==a){this.visible=a;this.dirty(1)}return this},show:function(){return this.setVisible(true)},hide:function(){return this.setVisible(false)},setAlpha:function(a){if(this.actionsToAnimate){this.actionsToAnimate--;return new jayus.MethodAnimator(this,this.setAlpha,this.alpha,a)}if(this.alpha!==a){this.alpha=a;this.dirty(16)}return this},updateCursor:function(a,b){if(this.underCursor)if(this.intersectsAt(a,b))this.isParent&&this.updateCursorOnChildren(a,b);else{this.underCursor=
false;this.fire("cursorOut");this.isParent&&this.removeCursorFromChildren()}else if(this.intersectsAt(a,b)){this.underCursor=true;this.fire("cursorOver");this.isParent&&this.updateCursorOnChildren(a,b)}},removeCursor:function(){if(this.underCursor){this.underCursor=false;this.fire("cursorOut");this.isParent&&this.removeCursorFromChildren()}},setDragButton:function(a){if(this.dragButton!==a){this.dragButton=a;if(this.draggable){this.setDraggable(false);this.setDraggable(true)}}return this},setDraggable:function(a){if(!this.draggable&&
a){this.addHandler(this.dragButton+"Press",function(b){this.dragging=true;this.canReleaseCursor=false;this.fire("dragStart");jayus.interceptNextEvent(this.dragButton+"Release",function(){this.dragging=false;this.canReleaseCursor=true;this.display.updateCursor(this.display.cursor.x,this.display.cursor.y)},{context:this});this.display=b.display;var c=this;b.display.addHandler("cursorMove",function(d){c.dragging?c.translate(d.deltaX,d.deltaY):c.display.removeHandler("cursorMove","dragHandler");return true},
{id:"dragHandler"})});this.draggable=true}return this},matrix:null,matrixDirty:true,getMatrix:function(){if(this.matrixDirty){if(this.matrix===null)this.matrix=new jayus.Matrix;else this.matrix.identity();this.applyTransforms(this.matrix);this.matrixDirty=false}return this.matrix},applyTransforms:function(a){if(this.isTransformed)if(this.xAnchor||this.yAnchor){a.translate(this.xAnchor,this.yAnchor);if(this.xScale!==1||this.yScale!==1)a.scale(this.xScale,this.yScale);this.angle!==0&&a.rotate(this.angle);
a.translate(-this.xAnchor,-this.yAnchor)}else{if(this.xScale!==1||this.yScale!==1)a.scale(this.xScale,this.yScale);this.angle!==0&&a.rotate(this.angle)}return this},setAngle:function(a){if(this.actionsToAnimate){this.actionsToAnimate--;return jayus.MethodAnimator(this,this.setAngle,this.angle,a)}if(this.angle!==a){this.angle=a;this.matrixDirty=this.isTransformed=true;this.dirty(8)}return this},rotate:function(a){return this.setAngle(this.angle+a)},setScale:function(a,b){if(arguments.length===1)b=
a;if(this.actionsToAnimate){this.actionsToAnimate--;return new jayus.MethodAnimator(this,this.setScale,[this.xScale,this.yScale],[a,b])}if(this.xScale!==a||this.yScale!==b){this.xScale=a;this.yScale=b;this.matrixDirty=this.isTransformed=true;this.dirty(8)}return this},scale:function(a,b){if(arguments.length===1)b=a;return this.setScale(this.xScale*a,this.yScale*b)},setAnchor:function(a,b){if(arguments.length===1){b=a.y;a=a.x}if(this.xAnchor!==a||this.yAnchor!==b){this.xAnchor=a;this.yAnchor=b;this.matrixDirty=
true;this.dirty(8)}return this},screenToLocal:function(a,b){if(arguments.length===1){b=a.y;a=a.x}if(this.hasParent)return this.parentToLocal(this.parent.screenToLocal(a,b));return new jayus.Point(a,b)},parentToLocal:function(a,b){if(arguments.length===1){b=a.y;a=a.x}if(this.hasParent){a-=this.x;b-=this.y;a/=this.xScale;b/=this.yScale;if(this.angle!==0){var c=a,d=b,e=Math.cos(this.angle),f=Math.sin(this.angle);a=e*c-f*d;b=e*d+f*c}}return new jayus.Point(a,b)},localToScreen:function(a,b){if(arguments.length===
1){b=a.y;a=a.x}if(this.hasParent)return this.parent.localToScreen(this.localToParent(a,b));return new jayus.Point(a,b)},localToScreenOnto:function(a,b,c){if(this.hasParent){this.localToParentOnto(a,b,c);this.parent.localToScreenOnto(c.x,c.y,c)}else{c.x=a;c.y=b}return c},localToParent:function(a,b){if(arguments.length===1){b=a.y;a=a.x}var c=new jayus.Point;this.localToParentOnto(a,b,c);return c},localToParentOnto:function(a,b,c){if(this.angle!==0){var d=a;b=b;var e=Math.cos(this.angle),f=Math.sin(this.angle);
a=e*d-f*b;b=e*b+f*d}a*=this.xScale;b*=this.yScale;a+=this.x;b+=this.y;c.x=a;c.y=b;return c},localToParentOntoORIGINAL:function(a,b,c){if(this.hasParent){if(this.angle!==0){var d=a;b=b;var e=Math.cos(this.angle),f=Math.sin(this.angle);a=e*d-f*b;b=e*b+f*d}a*=this.xScale;b*=this.yScale;a+=this.x;b+=this.y}c.x=a;c.y=b;return c},running:false,xVelocity:0,yVelocity:0,setVelocity:function(a,b){if(arguments.length===1){b=a.y;a=a.x}this.xVelocity=a;this.yVelocity=b;if(!this.running){jayus.animators.push(this);
this.running=true}},clearVelocity:function(){this.velocity=null;jayus.animators.splice(jayus.animators.indexOf(this),1);this.running=false},tick:function(a,b){this.translate(this.xVelocity*b,this.yVelocity*b)},intersects:function(a){return jayus.intersectTest(this,a)},intersectCount:function(a){var b,c=0;for(b=0;b<a.length;b++)jayus.intersectTest(this,a[b])&&c++;return c},intersectsAny:function(a){if(a instanceof jayus.List)a=a.items;for(var b=0;b<a.length;b++)if(jayus.intersectTest(this,a[b]))return true;
return false},intersectsAll:function(a){if(a instanceof jayus.List)a=a.items;for(var b=0;b<a.length;b++)if(!jayus.intersectTest(this,a[b]))return false;return true},intersectsWhich:function(a){if(a instanceof jayus.List)a=a.items;var b,c=[];for(b=0;b<a.length;b++)jayus.intersectTest(this,a[b])&&c.push(a[b]);return c},rasterize:function(){var a=this.getScope();a=new jayus.Surface(a.width,a.height);var b=this.x,c=this.y;this.y=this.x=0;this.drawOnto(a);this.x=b;this.y=c;return a},drawOnto:function(a){a=
a.context;a.save();this.drawOntoContext(a,0,0);a.restore();return this}});jayus.applyObject(jayus.Animatable.prototype,jayus.Entity.prototype);jayus.RectEntity=jayus.Entity.extend({shapeType:4,isRect:true,x:0,y:0,width:0,height:0,bg:null,hasBg:false,alignBg:false,bounds:null,boundsClone:null,body:null,setX:jayus.Rectangle.prototype.setX,setY:jayus.Rectangle.prototype.setY,getOrigin:jayus.Rectangle.prototype.getOrigin,setOrigin:jayus.Rectangle.prototype.setOrigin,translate:jayus.Rectangle.prototype.translate,getLeft:jayus.Rectangle.prototype.getLeft,getRight:jayus.Rectangle.prototype.getRight,getTop:jayus.Rectangle.prototype.getTop,getBottom:jayus.Rectangle.prototype.getBottom,
setLeft:jayus.Rectangle.prototype.setLeft,setRight:jayus.Rectangle.prototype.setRight,setTop:jayus.Rectangle.prototype.setTop,setBottom:jayus.Rectangle.prototype.setBottom,getPosAt:function(a,b){if(arguments.length===1){b=a.y;a=a.x}return this.localToParent(a*this.width,b*this.height)},setPosAt:function(a,b,c,d){if(arguments.length===3){d=c.y;c=c.x}return this.translate(c-(this.x+a*this.width),d-(this.y+b*this.height))},setRelativeAnchor:function(a,b){if(arguments.length===1){b=a.y;a=a.x}return this.setAnchor(this.width*
a,this.height*b)},setBody:function(a){if(this.body!==null)delete this.body.entity;else{jayus.box2d.physicalEntities.push(this);this.setAnchor(this.width/2,this.height/2)}this.body=a;this.body.entity=this;return this},removeBody:function(){if(this.body!==null){delete this.body.entity;this.body=null;jayus.box2d.physicalEntities.splice(jayus.box2d.physicalEntities.indexOf(this))}return this},updateFromBody:function(){if(this.body.IsAwake()){var a=this.body.GetPosition();this.setPosAt(0.5,0.5,a.x,a.y);
this.angle=this.body.GetAngle();this.matrixDirty=true}},changeSize:function(a,b){if(a!==this.width||b!==this.height){typeof this.formContents==="function"&&this.formContents(a,b);this.width=a;this.height=b;this.fire("resized");this.dirty(4)}},setWidth:function(a){if(this.hasFlexibleWidth()){a!==this.width&&this.changeSize(a,this.height);return this}throw Error("RectEntity.setWidth() - Entity width is not flexible");},setHeight:function(a){if(this.hasFlexibleHeight()){a!==this.height&&this.changeSize(this.width,
a);return this}throw Error("RectEntity.setHeight() - Entity height is not flexible");},setSize:function(a,b){if(arguments.length===1){b=a.height;a=a.width}if(this.hasFlexibleWidth()&&this.hasFlexibleHeight()){this.changeSize(a,b);return this}throw Error("RectEntity.setSize() - Entity size is not flexible");},setSizeFromParent:function(a,b){this.frozen--;this.setSize(a,b);this.frozen++},intersectsAt:function(a,b){return this.getBounds().intersectsAt(a,b)},getUnFrame:function(){return new jayus.Rectangle(this.x,
this.y,this.width,this.height)},getFrame:function(){if(this.isTransformed)return(new jayus.Polygon.Rectangle(0,0,this.width,this.height)).transform(this.getMatrix());return new jayus.Rectangle(this.x,this.y,this.width,this.height)},getScope:function(){return this.getFrame().getScope()},getBounds:function(){if(this.bounds!==null){this.bounds.cloneOnto(this.boundsClone);return this.boundsClone.translate(this.x,this.y)}return this.getFrame().getScope()},setBounds:function(a){this.bounds!==null&&this.bounds.detach(this);
this.bounds=a;this.bounds.attach(this);this.boundsClone=this.bounds.clone();this.shapeType=0;return this},clearBounds:function(){if(this.bounds!==null){this.bounds.detach(this);this.boundsClone=this.bounds=null;this.shapeType=4}return this},componentDirtied:function(a,b){b===this.bounds&&this.bounds.cloneOnto(this.boundsClone)},setBg:function(a){this.hasBg&&this.bg.detach(this);a instanceof jayus.Brush||(a=new jayus.Brush(a));this.bg=a;this.bg.attach(this);this.hasBg=true;return this.dirty(jayus.DIRTY.BACKGROUND)},
clearBg:function(){if(this.hasBg){this.bg.detach(this);this.bg=null;this.hasBg=false;this.dirty(jayus.DIRTY.BACKGROUND)}return this},buffered:false,bufferBg:true,canvas:null,context:null,setBuffering:function(a){if(!this.buffered&&a){this.canvas=document.createElement("canvas");this.context=this.canvas.getContext("2d");this.refreshBuffer()}else if(this.buffered&&!a)this.context=this.canvas=null;this.buffered=a;return this},refreshBuffer:function(){if(this.buffered){var a=this.canvas;if(this.width!==
a.width||this.height!==a.height){a.width=this.width;a.height=this.height}this.fullyRefreshBuffer()}},fullyRefreshBuffer:function(){if(this.buffered){var a=this.context;a.clearRect(0,0,this.width,this.height);a.save();this.bufferBg&&this.hasBg&&this.bg.paintRect(a,0,0,this.width,this.height);this.paintContents(a);a.restore()}},keepAligned:false,applyTransforms:function(a){if(this.xScale!==1||this.yScale!==1||this.angle)if(this.xAnchor||this.yAnchor){this.keepAligned?a.translate(Math.round(this.x)+
this.xAnchor,Math.round(this.y)+this.yAnchor):a.translate(this.x+this.xAnchor,this.y+this.yAnchor);if(this.xScale!==1||this.yScale!==1)a.scale(this.xScale,this.yScale);this.angle!==0&&a.rotate(this.angle);a.translate(-this.xAnchor,-this.yAnchor)}else{this.keepAligned?a.translate(Math.round(this.x),Math.round(this.y)):a.translate(this.x,this.y);if(this.xScale!==1||this.yScale!==1)a.scale(this.xScale,this.yScale);this.angle!==0&&a.rotate(this.angle)}else if(this.x||this.y)this.keepAligned?a.translate(Math.round(this.x),
Math.round(this.y)):a.translate(this.x,this.y);return this},drawOntoContext:function(a){a.save();if(this.alpha!==1)a.globalAlpha*=this.alpha;this.applyTransforms(a);if(this.buffered){this.dirtied&&this.refreshBuffer();if(!this.bufferBg&&this.hasBg)this.alignBg?this.bg.paintRect(a,0.5,0.5,Math.round(this.width),Math.round(this.height)):this.bg.paintRect(a,0,0,this.width,this.height);a.drawImage(this.canvas,0,0)}else{if(this.hasBg)this.alignBg?this.bg.paintRect(a,0.5,0.5,Math.round(this.width),Math.round(this.height)):
this.bg.paintRect(a,0,0,this.width,this.height);this.paintContents(a)}this.dirtied=false;a.restore();return this}});jayus.PaintedShape=jayus.Entity.extend({shape:null,brush:null,hasBrush:false,init:function(a,b){jayus.Entity.prototype.init.apply(this);this.shape=a;a.attach(this);b!==undefined&&this.setBrush(b)},componentDirtied:function(){this.dirty(16)},translate:function(a,b){this.shape.translate.call(this.shape,a,b);this.dirty(2)},intersectsAt:function(a,b){if(this.isTransformed){var c=this.getMatrix().inverseTransformPoint(a,b);a=c.x;b=c.y}return this.shape.intersectsAt(a,b)},setShape:function(a){if(this.shape!==
a){this.shape.detach(this);this.shape=a;a.attach(this);this.dirty(jayus.DIRTY.ALL)}return this},setBrush:function(a){this.hasBrush&&this.brush.detach(this);a instanceof jayus.Brush||(a=new jayus.Brush(a));this.brush=a;a.attach(this);this.hasBrush=true;return this.dirty(16)},clearBrush:function(){if(this.hasBrush){this.brush.detach(this);this.brush=null;this.hasBrush=false;this.dirty(16)}return this},getScope:function(){if(!this.isTransformed)return this.shape.getScope();var a=this.shape.getScope().getTransformed(this.getMatrix()).getScope();
if(this.brush.stroking||this.brush.shadowing){var b=Math.max(this.xScale,this.yScale),c=0,d=0,e=0,f=0;if(this.brush.stroking)c=d=e=f=(this.brush.miterLimit===undefined?10:this.brush.miterLimit)*b/1.5;if(this.brush.shadowing){c=Math.max(c,c+this.brush.shadowBlur-this.brush.shadowOffsetX);d=Math.max(d,d+this.brush.shadowBlur+this.brush.shadowOffsetX);e=Math.max(e,e+this.brush.shadowBlur-this.brush.shadowOffsetY);f=Math.max(f,f+this.brush.shadowBlur+this.brush.shadowOffsetY)}a.setSize(a.width+c+d,a.height+
e+f);a.translate(-c,-e)}return a},getBounds:function(){return this.shape},drawOntoContext:function(a){if(this.hasBrush){a.save();if(this.alpha!==1)a.globalAlpha*=this.alpha;this.applyTransforms(a);this.shape.etchOntoContext(a);this.brush.paintShape(a);a.restore()}}});jayus.Text=jayus.RectEntity.extend({text:"",font:"12pt sans-serif",brush:null,hasBrush:false,alignment:0,fontDesc:null,lines:null,lineWidths:null,init:function(a,b,c){jayus.Entity.prototype.init.apply(this);if(arguments.length){this.text=a;if(arguments.length>1){this.font=b;arguments.length>2&&this.setBrush(c)}}this.refreshMetrics()},componentDirtied:function(){this.dirty(16)},hasFlexibleWidth:function(){return false},hasFlexibleHeight:function(){return false},refreshMetrics:function(){if(this.fontDesc===
null)this.fontDesc=jayus.getFontDescriptor(this.font);this.lines=this.text.split("\n");if(this.lineWidths===null)this.lineWidths=[];else this.lineWidths.length=this.lines.length;for(var a={},b=0;b<this.lines.length;b++)this.lineWidths[b]=jayus.measureTextOnto(this.lines[b],this.font,a).width;this.changeSize(jayus.math.max(this.lineWidths),this.lines.length*this.fontDesc.height)},getScope:function(){var a=this.getFrame().getScope();if(this.hasBrush)if(this.brush.stroking||this.brush.shadowing){var b=
Math.max(this.xScale,this.yScale),c=0,d=0,e=0,f=0;if(this.brush.stroking){b=this.brush.lineWidth*b/2;c=d=e=f=Math.sqrt(b*b*2)}if(this.brush.shadowing){c=Math.max(c,c+this.brush.shadowBlur-this.brush.shadowOffsetX);d=Math.max(d,d+this.brush.shadowBlur+this.brush.shadowOffsetX);e=Math.max(e,e+this.brush.shadowBlur-this.brush.shadowOffsetY);f=Math.max(f,f+this.brush.shadowBlur+this.brush.shadowOffsetY)}a.setSize(a.width+c+d,a.height+e+f);a.translate(-c,-e)}return a},setText:function(a){if(this.text!==
a){this.text=a;this.refreshMetrics();this.dirty(16)}return this},setFont:function(a){if(this.font!==a){this.font=a;this.fontDesc=null;this.refreshMetrics()}return this},setAlignment:function(a){if(this.alignment!==a){this.alignment=a;this.lines.length>1&&this.dirty(16)}return this},setBrush:function(a){this.hasBrush&&this.brush.detach(this);a instanceof jayus.Brush||(a=new jayus.Brush(a));this.brush=a;this.brush.attach(this);this.hasBrush=true;return this.dirty(jayus.DIRTY.ALL)},clearBrush:function(){if(this.hasBrush){this.brush.detach(this);
this.brush=null;this.hasBrush=false;this.dirty(jayus.DIRTY.ALL)}return this},paintContents:function(a){var b=this.fontDesc.ascent,c=this.fontDesc.height;this.brush.applyTo(a);a.font=this.font;var d,e,f;for(d=0;d<this.lines.length;d++){e=this.lines[d];f=(this.width-this.lineWidths[d])*this.alignment;this.brush.stroking&&this.brush.strokeFirst&&a.strokeText(e,f,b+d*c);this.brush.filling&&a.fillText(e,f,b+d*c);this.brush.stroking&&!this.brush.strokeFirst&&a.strokeText(e,f,b+d*c)}}});jayus.TextBox=jayus.Text.extend({hasFlexibleWidth:function(){return true},hasFlexibleHeight:function(){return true},refreshMetrics:function(){if(this.fontDesc===null)this.fontDesc=jayus.getFontDescriptor(this.font);for(var a={},b=this.font,c=[],d=[],e=function(k,l){var n,o=[],m="";for(n=0;n<k.length;n++)if(l.indexOf(k[n])>=0){o.push(m);o.push(k[n]);m=""}else m+=k[n];o.push(m);return o}(this.text," \n"),f=0,h,g,i,j;f!==e.length;){h="\n";g=0;i=e[f];j=jayus.measureTextOnto(i,b,a).width;do{if(i==="\n"){f++;
break}h+=i;g+=j;f++;if(f===e.length)break;i=e[f];j=jayus.measureTextOnto(i,b,a).width}while(g+j<this.width);if(h.length){c.push(h);d.push(g)}}this.lines=c;this.lineWidths=d}});jayus.Grid=jayus.RectEntity.extend({isParent:true,slotWidth:10,slotHeight:10,xPadding:0,yPadding:0,items:null,init:function(){jayus.RectEntity.prototype.init.apply(this);this.items=[[null]]},childMoved:function(){this.dirty()},childDirtied:function(){this.dirty()},updateSize:function(){return this.updateWidth().updateHeight()},updateWidth:function(){return this.setWidth(this.items[0].length*this.slotWidth+(this.items[0].length-1)*this.xPadding)},updateHeight:function(){return this.setHeight(this.items.length*
this.slotHeight+(this.items.length-1)*this.yPadding)},setSlotWidth:function(a){if(this.slotWidth!==a){this.slotWidth=a;this.updateSize()}return this},setSlotHeight:function(a){if(this.slotHeight!==a){this.slotHeight=a;this.updateSize()}return this},setSlotSize:function(a,b){if(arguments.length===1){b=a.height;a=a.width}if(this.slotWidth!==a||this.slotHeight!==b){this.slotWidth=a;this.slotHeight=b;this.updateSize()}return this},setPadding:function(a,b){if(arguments.length===1){b=a.y;a=a.x}this.xPadding=
a;this.yPadding=b},count:function(){var a,b,c=0;for(a=0;a<this.getRowCount();a++)for(b=0;b<this.getColumnCount();b++)this.items[a][b]!==null&&c++;return c},slotCount:function(){return this.items.length*this.items[0].length},hasSlot:function(a,b){if(arguments.length===1){b=a.y;a=a.x}return this.hasColumn(a)&&this.hasRow(b)},hasColumn:function(a){return 0<=a&&a<this.items[0].length},hasRow:function(a){return 0<=a&&a<this.items.length},hasChild:function(a){var b,c;if(a instanceof jayus.Entity)for(b=
0;b<this.getRowCount();b++){if(this.items[0].indexOf(a)>=0)return true}else for(b=0;b<this.getRowCount();b++)for(c=0;c<this.getColumnCount();c++)if(this.items[b][c].id===a)return true;return false},indexOf:function(a){var b,c;if(a instanceof jayus.Entity)for(b=0;b<this.getRowCount();b++){c=this.items[0].indexOf(a);if(c>=0)return new jayus.Point(c,b)}else for(b=0;b<this.getRowCount();b++)for(c=0;c<this.getColumnCount();c++)if(this.get(c,b).id===id)return new jayus.Point(c,b);return null},getChild:overloadArgumentType({object:function(a){return this.getChild(a.y,
a.x)},number:function(a,b){if(this.hasSlot(a,b))return this.items[b][a];return null},string:function(a){var b,c;for(b=0;b<this.getRowCount();b++)for(c=0;c<this.getColumnCount();c++)if(this.getChildAt(c,b).id===a)return this.items[b][c];return null}}),setChild:overloadArgumentCount({2:function(a,b){return this.setChild(a.x,a.y,b)},3:function(a,b,c){if(this.hasSlot(a,b)){var d=this.items[b][a];d!==null&&d.removeParent();this.items[b][a]=c;if(c!==null){c.setParent(this);c.translate(a*this.slotWidth+
a*this.xPadding,b*this.slotHeight+b*this.yPadding)}this.dirty()}return this}}),getChildAt:function(a,b){if(arguments.length===1){b=a.y;a=a.x}var c=null;this.forEach(function(){if(this.intersectsAt(a,b)){c=this;return null}});return c},getSlotAt:function(a,b){if(arguments.length===1){b=a.y;a=a.x}a-=this.x;b-=this.y;return new jayus.Point(Math.floor(a/this.slotWidth),Math.floor(b/this.slotHeight))},getSlotFrame:function(a,b){if(arguments.length===1){b=a.y;a=a.x}return this.hasSlot(a,b)?new jayus.Rectangle(this.x+
a*(this.slotWidth+this.xPadding),this.y+b*(this.slotHeight+this.yPadding),this.slotWidth,this.slotHeight):null},removeChild:overloadArgumentType({object:function(a){for(var b=0;b<this.getRowCount();b++)for(var c=0;c<this.getColumnCount();c++)if(this.getChild(b,c)===a){a.removeParent();this.items[b][c]=null;return this}return this},string:function(a){for(var b=0;b<this.getRowCount();b++)for(var c=0;c<this.getColumnCount();c++)if(this.getChild(b,c).id===a){this.items[b][c].removeParent();this.items[b][c]=
null;return this}return this},number:function(a,b){if(this.has(a,b)){this.items[a][b].removeParent();this.items[a][b]=null}return this}}),setGridSize:function(a,b){return this.setColumnCount(a).setRowCount(b)},getRowCount:function(){return this.items.length},setRowCount:function(a){for(;a<this.getRowCount();)this.removeRow();for(;a>this.getRowCount();)this.addRow();return this},addRow:function(a){for(arguments.length||(a=[]);a.length<this.getColumnCount();)a.push(null);this.items.push(a);this.updateSize();
return this.dirty()},removeRow:function(a){this.forEachInRow(a,function(){this.removeParent()});this.getRowCount()>1&&this.hasRow(a)&&this.items.splice(a,1);this.updateSize();return this.dirty()},getColumnCount:function(){return this.items[0].length},setColumnCount:function(a){for(;a<this.getColumnCount();)this.removeColumn();for(;a>this.getColumnCount();)this.addColumn();return this},addColumn:function(a){for(arguments.length||(a=[]);a.length<this.getRowCount();)a.push(null);for(var b=0;b<this.getRowCount();b++)this.items[b].push(a[b]);
this.updateSize();return this.dirty()},removeColumn:function(a){this.forEachInColumn(a,function(){this.removeParent()});if(this.getColumnCount()>1&&this.hasColumn(a))for(var b=0;b<this.getRowCount();b++)this.items[b].splice(a,1);this.updateSize();return this.dirty()},onEach:function(a,b){return this.forEachSlot(function(c){c!==null&&c[a].apply(c,b)})},forEach:function(a){return this.forEachSlot(function(b,c,d){d!==null&&a.call(this,b,c,d)})},forEachInRow:function(a,b,c){if(this.hasRow(a))for(var d=
0,e;d<this.getColumnCount();d++){e=this.items[a][d];e!==null&&b.apply(e,c)}return this},forEachInColumn:function(a,b,c){if(this.hasColumn(a))for(var d=0,e;d<this.getRowCount();d++){e=this.items[d][a];e!==null&&b.apply(e,c)}return this},forEachSlot:function(a){for(var b=0;b<this.items.length;b++)for(var c=0;c<this.items[0].length;c++)if(a.call(this,b,c,this.items[b][c])===null)return this;return this},findCursorAcceptor:function(){var a=null;this.forEach(function(b,c,d){if(d.underCursor){if(d.isParent){acceptor=
d.findCursorAcceptor();if(acceptor!==null){a=acceptor;return null}}if(d.canAcceptCursor){a=d;return null}}});return a},fireOnEach:function(a,b){var c,d;for(c=0;c<this.getRowCount();c++)for(d=0;d<this.getColumnCount();d++)if(this.has(c,d))if(this.get(c,d).fire(a,b))return true;return false},fireOnCursor:function(a,b){var c,d,e;for(c=0;c<this.items.length;c++)for(d=0;d<this.items[c].length;d++){e=this.items[c];if(e.underCursor){if(e.isParent&&e.fireOnCursor(a,b))return true;if(e.fire(a,b))return true}}return false},
updateCursorOnChildren:function(a,b){var c=this.parentToLocal(a,b);if(this.isTransformed)c=this.getMatrix().inverseTransformPoint(c.x,c.y);a=c.x;b=c.y;this.forEach(function(d,e,f){f.trackCursor&&jayus.util.updateCursorOnChild(f,a,b)})},removeCursorFromChildren:function(){this.forEach(function(a,b,c){c.removeCursor()})},runOnCursor:function(a,b){this.forEach(function(c,d,e){if(e.underCursor){if(e.isParent&&e.runOnCursor(a,b))return true;if(a.apply(e,b))return true}})},paintContents:function(a){var b,
c,d;for(b=0;b<this.items.length;b++)for(c=0;c<this.items[b].length;c++){d=this.items[b][c];d!==null&&d.visible&&d.drawOntoContext(a)}}});jayus.Image=jayus.RectEntity.extend({image:null,hasSection:false,section:null,keepAligned:false,loaded:false,init:function(a){jayus.Entity.prototype.init.apply(this);if(typeof a==="string")if(jayus.images.isLoaded(a)){this.loaded=true;this.image=jayus.images.images[a];this.width=this.image.width;this.height=this.image.height}else{var b=this;jayus.addHandler("imageLoaded",function(c){if(c.filepath===a){b.loaded=true;b.image=c.image;b.hasSection||b.changeSize(c.image.width,c.image.height)}});jayus.images.load(a)}else{this.loaded=
true;this.image=a;this.width=this.image.width;this.height=this.image.height}},hasFlexibleWidth:function(){return false},hasFlexibleHeight:function(){return false},setSource:function(a){if(typeof a==="string")if(jayus.images.isLoaded(a)){this.loaded=true;this.image=jayus.images.images[a];this.changeSize(this.image.width,this.image.height)}else{var b=this;jayus.images.load(a,function(c,d){b.loaded=true;b.image=jayus.images.images[a];b.changeSize(d.width,d.height)})}else{this.loaded=true;this.image=
a;this.changeSize(this.image.width,this.image.height)}},setSection:function(a,b,c,d){if(arguments.length===1){d=a.height;c=a.width;b=a.y;a=a.x}else if(arguments.length===3){d=c;c=b;b=a.y;a=a.x}this.hasSection=true;if(this.width!==c||this.height!==d){this.sectionY=b;this.sectionX=a;this.changeSize(c,d)}else if(this.sectionX!==a||this.sectionY!==b){this.sectionY=b;this.sectionX=a;this.dirty(16)}return this},clearSection:function(){if(this.hasSection){this.hasSection=false;this.changeSize(this.image.width,
this.image.height)}return this},toPattern:function(a){arguments.length||(a="repeat");return this.rasterize().toPattern(a)},paintContents:function(a){var b=this.image;if(b instanceof jayus.Surface)b=b.canvas;this.hasSection?a.drawImage(b,this.sectionX,this.sectionY,this.width,this.height,0,0,this.width,this.height):a.drawImage(b,0,0);return this}});jayus.Sprite=jayus.Image.extend({animation:null,animator:null,spriteIndexX:null,spriteIndexY:null,setSpriteSheet:function(a){this.sheet=a;return this},setSprite:function(a,b){if(arguments.length===1){b=a.y;a=a.x}if(this.sheet!==null||typeof this.image.sheet==="object")if(this.spriteIndexX!==a||this.spriteIndexY!==b){var c=this.sheet||this.image.sheet;this.spriteIndexX=a;this.spriteIndexY=b;this.setSection(c.marginX+a*c.spriteWidth,c.marginY+b*c.spriteHeight,c.spriteWidth,c.spriteHeight);this.dirty(4)}return this},
playAnimation:function(a,b){this.setAnimation(a,false);arguments.length>1&&this.animator.addHandler("finished",b);return this},loopAnimation:function(a){return this.setAnimation(a,true)},stopAnimation:function(){this.animator!==null&&this.animator.stop()},setAnimation:function(a,b){if(this.sheet!==null||typeof this.image.sheet==="object"){var c=this.sheet||this.image.sheet;if(c.hasAnimation(a)){this.animator!==null&&this.animator.stop();this.animation=a;var d=c.animations[a],e=d.sprites,f=this;if(d.flipX||
d.flipY){this.setAnchor(this.width/2,this.height/2);d.flipX?this.setScale(-1,this.yScale):this.setScale(1,this.yScale);d.flipY?this.setScale(this.xScale,-1):this.setScale(this.xScale,1)}else this.setScale(1,1);this.animator=new jayus.Animator.Discrete(e.length,function(h){f.setSprite(e[h])});this.animator.setDuration(c.animations[a].duration).setLooped(b).start()}}return this},playSequence:function(a){var b,c,d=new jayus.AnimatorSequence,e=this.sheet||this.image.sheet;for(b=0;b<a.length;b++)d.add((new jayus.Sprite.SpriteSequence(this,
e.animations[a[b]].sprites)).setDuration(e.animations[a[b]].duration));this.animator.stop();this.animator=d;c=this.animation;this.animation=a;d.addHandler("finished",function(){this.setAnimation(c)},{context:this});d.start();return d}});jayus.SpriteSheet=jayus.Dependency.extend({spriteWidth:32,spriteHeight:32,spacingX:0,spacingY:0,marginX:0,marginY:0,animations:null,init:function(a){this.animations={};if(arguments.length)jayus.images.images[a].sheet=this},setSpriteSize:function(a,b){if(arguments.length===1){b=a.height;a=a.width}if(this.spriteWidth!==a||this.spriteHeight!==b){this.spriteWidth=a;this.spriteHeight=b;this.dirty(4)}return this},setSpacing:function(a,b){if(arguments.length===1){b=a.y;a=a.x}if(this.spacingX!==a||this.spacingY!==
b){this.spacingX=a;this.spacingY=b}return this},setMargin:function(a,b){if(arguments.length===1){b=a.y;a=a.x}if(this.marginX!==a||this.marginY!==b){this.marginX=a;this.marginY=b}return this},hasAnimation:function(a){return typeof this.animations[a]==="object"},addAnimation:function(a,b,c){if(arguments.length===2)c=1E3;this.animations[a]={sprites:b,duration:c,flipX:false,flipY:false};return this},add:function(a){for(var b in a)if(a.hasOwnProperty(b)){var c=a[b];if(typeof c.flipX==="undefined")c.flipX=
false;if(typeof c.flipY==="undefined")c.flipY=false;if(typeof c.duration==="undefined")c.duration=1E3;this.animations[b]=c}return this},setAnimationDuration:function(a,b){this.animations[a].duration=b;return this},setAnimationFlipping:function(a,b,c){this.animations[a].flipX=b;this.animations[a].flipY=c;return this}});jayus.Surface=jayus.RectEntity.extend({width:300,height:150,canvas:null,context:null,negateBlur:false,init:function(a,b){jayus.Entity.prototype.init.apply(this);if(arguments.length===2){this.width=a;this.height=b}this.canvas=document.createElement("canvas");this.canvas.width=this.width;this.canvas.height=this.height;this.context=this.canvas.getContext("2d")},hasFlexibleWidth:function(){return true},hasFlexibleHeight:function(){return true},formContents:function(a,b){this.canvas.width=a;this.canvas.height=
b},clear:function(){this.context.clearRect(0,0,this.width,this.height);return this},fill:overloadArgumentCount({1:function(a){return this.fill(a.r,a.g,a.b,a.a)},2:function(a,b){return this.fill(a.r,a.g,a.b,a.a*b)},3:function(a,b,c){return this.fill(a,b,c,1)},4:function(a,b,c,d){var e=this.context;e.save();e.fillStyle="rgba("+a+","+b+","+c+","+d+")";e.globalCompositeOperation="copy";e.fillRect(0,0,this.width,this.height);e.restore();return this}}),getBuffer:function(a,b,c,d){if(arguments.length===
0){d=this.height;c=this.width;a=b=0}else if(arguments.length===1){d=a.height;c=a.width;b=a.y;a=a.x}else if(arguments.length===3){d=c;c=b;b=a.y;a=a.x}return this.context.getImageData(a,b,c,d)},putBuffer:function(a,b,c){if(arguments.length===1){c=a;a=b=0}else if(arguments.length===2){c=b;b=a.y;a=a.x}this.context.putImageData(c,a,b);return this.dirty(16)},getPixel:function(a,b){if(arguments.length===1){b=a.y;a=a.x}var c=this.getBuffer(a,b,1,1).data;return new jayus.Color(c[0],c[1],c[2],c[3]/255)},setPixel:overloadArgumentCount({2:function(a,
b){return this.setPixel(a.x,a.y,b.r,b.g,b.b,b.a)},3:function(a,b,c){return this.setPixel(a,b,c.r,c.g,c.b,c.a)},4:function(a,b,c,d){return this.setPixel(a.x,a.y,b,c,d,1)},5:function(a,b,c,d,e){return this.setPixel(a,b,c,d,e,1)},6:function(a,b,c,d,e,f){var h=this.context.createImageData(1,1),g=h.data;g[0]=c;g[1]=d;g[2]=e;g[3]=f*255;return this.putBuffer(a,b,h)}}),getPixelFrame:function(a,b){if(arguments.length===1){b=a.y;a=a.x}return new jayus.Rectangle(this.x+a*this.xScale,this.y+b*this.yScale,this.xScale,
this.yScale)},getPixelAt:function(a,b){if(arguments.length===1){b=a.y;a=a.x}if(this.intersectsAt(a,b)){a===this.getRight()&&a--;b===this.getBottom()&&b--;return new jayus.Point(Math.floor((a-this.getLeft())/this.xScale),Math.floor((b-this.getTop())/this.yScale))}return null},blurImage:function(a){var b=this.getBuffer().data,c=this.width,d=this.height,e=this.context.createImageData(c,d),f=e.data,h,g,i,j,k,l,n,o,m,p,q=0;for(g=0;g<d;g++)for(h=0;h<c;h++){k=n=l=o=m=0;for(j=g-a;j<g+1+a;j++)if(j>=0&&j<d)for(i=
h-a;i<h+1+a;i++)if(i>=0&&i<c){p=(j*c+i)*4;k+=b[p];n+=b[p+1];l+=b[p+2];o+=b[p+3];m++}f[q]=k/m;f[q+1]=n/m;f[q+2]=l/m;f[q+3]=o/m;q+=4}return this.putBuffer(e).dirty()},exportPNG:function(){window.open(this.canvas.toDataURL("image/png"),"_blank");return this},toPattern:function(a){arguments.length||(a="repeat");return this.context.createPattern(this.canvas,a)},paintContents:function(a){if(this.negateBlur){var b=this.getBuffer().data,c,d,e;for(d=0;d<this.height;d++)for(c=0;c<this.width;c++){e=4*(c+this.width*
d);a.fillStyle="rgba("+b[e]+","+b[e+1]+","+b[e+2]+","+b[e+3]/255+")";a.fillRect(this.x+c,this.y+d,1,1)}}else a.drawImage(this.canvas,0,0)}});jayus.Group={isParent:true,propagateCursor:true,findChild:function(a){var b,c;for(b=0;b<this.children.items.length;b++){c=this.children.items[b];if(c.id===a)return c;if(c.isParent){c=c.findChild(a);if(c!==null)return c}}return null},getAllChildren:function(a){var b,c,d=[];for(b=0;b<this.children.items.length;b++){c=this.children.items[b];if(c.isParent)d=a?d.concat(c,c.getAllChildren(a)):d.concat(c.getAllChildren(a),c);else d.push(c)}return d},getChildrenUnderCursor:function(){var a,b=[];for(a=0;a<
this.children.items.length;a++)this.children.items[a].underCursor&&b.push(this.children.items[a]);return b},getChildrenAt:function(a,b){if(arguments.length===1){b=a.y;a=a.x}var c,d=[];for(c=0;c<this.children.items.length;c++)this.children.items[c].intersectsAt(a,b)&&d.push(this.children.items[c]);return d},runOnCursor:function(a,b){var c,d;for(c=this.children.items.length-1;c>=0;c--){d=this.children.items[c];if(d.underCursor){if(d.isParent&&d.runOnCursor(a,b))return true;if(a.apply(d,b))return true}}return false},
forEachChild:function(a,b){return this.children.forEach(a,b)},fireOnChildren:function(a,b){var c,d;for(c=0;c<this.children.items.length;c++){d=this.children.items[c];if(d.isParent&&d.fireOnChildren(a,b))return true;if(d.fire(a,b))return true}return false},fireOnCursor:function(a,b){var c,d;for(c=this.children.items.length-1;c>=0;c--){d=this.children.items[c];if(d.underCursor){if(d.isParent&&d.fireOnCursor(a,b))return true;if(d.fire(a,b))return true}}return false},updateCursorOnChildren:function(a,
b){var c,d;if(this.propagateCursor){c=this.parentToLocal(a,b);a=c.x;b=c.y;for(c=this.children.items.length-1;c>=0;c--){d=this.children.items[c];d.trackCursor&&d.updateCursor(a,b)}}},findCursorAcceptor:function(){var a,b,c;for(a=this.children.items.length-1;a>=0;a--){b=this.children.items[a];if(b.underCursor){if(b.isParent){c=b.findCursorAcceptor();if(c!==null)return c}if(b.canAcceptCursor)return b}}return null},removeCursorFromChildren:function(){var a,b;for(a=0;a<this.children.items.length;a++){b=
this.children.items[a];if(b.underCursor){b.underCursor=false;b.fire("cursorOut");b.isParent&&b.removeCursorFromChildren()}}}};jayus.Wrapper={isParent:false,child:null,propagateCursor:true,updateCursorOnChildren:function(a,b){this.localX=a;this.localY=b;if(this.propagateCursor){var c=this.parentToLocal(a,b);jayus.util.updateCursorOnChild(this.child,c.x,c.y)}},removeCursorFromChildren:function(){this.child.removeCursor()},findCursorAcceptor:function(){if(this.child.underCursor)if(this.child.isParent){var a=this.child.findCursorAcceptor();if(a!==null)return a;if(this.child.canAcceptCursor)return this.child}else return this.child;
return null},getChild:function(){return this.child},hasChild:function(){return this.isParent},setChild:function(a){this.child=a;a.setParent(this);this.isParent=true;return this},removeChild:function(){this.child.removeParent();this.child=null;this.isParent=false;return this},findChild:function(a){if(this.isParent){if(this.child.id===a)return this.child;if(this.child.isParent)return this.child.findChild(a)}return null},onEachChild:function(a,b){return this.child[a].apply(this.child,b)},forEachChild:function(a,
b){return a.apply(this.child,b)},runOnCursor:function(a,b){if(this.child.underCursor){if(this.child.isParent&&this.child.runOnCursor(a,b))return true;if(a.apply(this.child,b))return true}return false},fireOnChildren:function(a,b){return this.child.fire(a,b)},fireOnCursor:function(a,b){if(this.child.trackCursor&&this.child.underCursor){if(this.child.isParent&&this.child.fireOnCursor(a,b))return true;return this.child.fire(a,b)}return false}};jayus.Layer=jayus.Entity.extend({x:0,y:0,childrenAdded:null,componentDirtied:function(a,b,c){if(a==="ENTITY"){if(c&jayus.DIRTY.SCOPE)b.scopeChanged=true;this.scopeClean=false}this.dirty(16)},listItemAdded:function(a,b){if(this.childrenAdded===null)this.childrenAdded=[];this.childrenAdded.push(b);b.prevScope=b.getScope();b.setParent(this);this.dirty(16)},listItemsAdded:function(a,b){if(this.childrenAdded===null)this.childrenAdded=[];for(var c,d=0;d<b.length;d++){c=b[d];c.setParent(this);this.childrenAdded.push(c);
c.prevScope=c.getScope()}this.dirty(16)},listItemRemoved:function(a,b){b.removeParent();this.redrawAll=true;this.dirty(16)},listItemsRemoved:function(a,b){for(var c=0;c<b.length;c++)b[c].removeParent();this.redrawAll=true;this.dirty(16)},init:function(a,b){jayus.Entity.prototype.init.apply(this);this.children=new jayus.List(this);this.scope=new jayus.Rectangle;if(arguments.length===2){this.width=a;this.height=b}},scope:null,scopeClean:false,getScope:function(){var a,b,c,d,e,f;if(!this.scopeClean)if(this.children.items.length){f=
e=d=c=null;for(a=0;a<this.children.items.length;a++){b=this.children.items[a].getScope();if(c===null||b.x<c)c=b.x;if(e===null||b.x+b.width>e)e=b.x+b.width;if(d===null||b.y<d)d=b.y;if(f===null||b.y+b.height>f)f=b.y+b.height}this.scope.setFrame(c,d,e-c,f-d)}else this.scope.setFrame(0,0,0,0);return this.scope},translate:function(a,b){var c,d;for(c=0;c<this.children.items.length;c++){d=this.children.items[c];d.translate(a,b)}},intersectsAt:function(){return true},drawOntoContext:function(a){var b,c;for(b=
0;b<this.children.items.length;b++){c=this.children.items[b];c.visible&&c.drawOntoContext(a)}}});jayus.applyObject(jayus.Group,jayus.Layer.prototype);jayus.Scene=jayus.RectEntity.extend({hasWorld:false,world:null,childrenAdded:null,componentDirtied:function(a,b,c){if(a==="ENTITY")if(c&jayus.DIRTY.SCOPE)b.scopeChanged=true;jayus.RectEntity.prototype.componentDirtied.call(this,a,b,c);this.dirty(16)},listItemAdded:function(a,b){if(this.childrenAdded===null)this.childrenAdded=[];this.childrenAdded.push(b);b.prevScope=b.getScope();b.setParent(this);this.dirty(16)},listItemsAdded:function(a,b){if(this.childrenAdded===null)this.childrenAdded=[];for(var c,
d=0;d<b.length;d++){c=b[d];c.setParent(this);this.childrenAdded.push(c);c.prevScope=c.getScope()}this.dirty(16)},listItemRemoved:function(a,b){b.removeParent();this.redrawAll=true;this.dirty(16)},listItemsRemoved:function(a,b){for(var c=0;c<b.length;c++)b[c].removeParent();this.redrawAll=true;this.dirty(16)},hasFlexibleWidth:function(){return true},hasFlexibleHeight:function(){return true},formContents:function(a,b){if(this.buffered){this.canvas.width=a;this.canvas.height=b}},init:function(a,b){jayus.Entity.prototype.init.apply(this);
this.children=new jayus.List(this);if(arguments.length){this.width=a;this.height=b}},optimizeBuffering:false,groupDamagedRegions:true,damagedRegionPadding:2,setOptimizedBuffering:function(a){if(this.optimizeBuffering!==a){this.optimizeBuffering=a;this.redrawAll=true;this.dirty(16)}return this},refreshBuffer:function(){if(this.buffered){var a=this.width,b=this.height,c=this.canvas;if(a!==c.width||b!==c.height){c.width=a;c.height=b}if(this.optimizeBuffering&&!this.redrawAll)this.optimizedRefreshBuffer();
else{this.fullyRefreshBuffer();this.redrawAll=false}this.dirtied=false}},optimizedRefreshBuffer:function(){if(this.buffered){var a=this.context,b,c,d,e=[];for(b=0;b<this.children.items.length;b++){c=this.children.items[b];c.clean=true;if(c.scopeChanged){e.push(c.getScope().includeRectangle(c.prevScope));c.prevScope=c.getScope();c.scopeChanged=false;c.clean=false}else if(c.dirtied){e.push(c.getScope());c.dirtied=false;c.clean=false}}c=false;if(this.groupDamagedRegions)for(;!c;){c=true;for(b=0;b<e.length;b++){d=
e[b];for(i2=0;i2<e.length;i2++){region2=e[i2];if(d!==region2&&jayus.intersectTest(d,region2)){e[b].includeRectangle(region2);e.splice(i2,1);c=false;b>=i2&&b--;i2--}}}}c=this.damagedRegionPadding;for(b=0;b<e.length;b++){d=e[b];d.translate(-c,-c);d.setSize(d.width+c*2,d.height+c*2)}for(b=0;b<e.length;b++){d=e[b];for(i2=0;i2<this.children.items.length;i2++){c=this.children.items[i2];if(c.clean&&jayus.intersectTest(c,d))c.clean=false}}a.save();for(b=0;b<e.length;b++){d=e[b];a.clearRect(d.x,d.y,d.width,
d.height)}a.beginPath();for(b=0;b<e.length;b++){d=e[b];a.rect(d.x,d.y,d.width,d.height)}a.clip();if(this.bufferBg&&this.hasBg)this.alignBg?this.bg.paintRect(a,0.5,0.5,Math.round(this.width),Math.round(this.height)):this.bg.paintRect(a,0,0,this.width,this.height);for(b=0;b<this.children.items.length;b++){c=this.children.items[b];!c.clean&&c.visible&&c.drawOntoContext(a)}a.restore()}},paintContents:function(a){var b,c;for(b=0;b<this.children.items.length;b++){c=this.children.items[b];c.visible&&c.drawOntoContext(a)}}});
jayus.applyObject(jayus.Group,jayus.Scene.prototype);jayus.Display=jayus.Scene.extend({buffered:true,cursor:new jayus.Point,suppressContextMenu:true,suppressSelection:true,pendMousemoveEvents:true,hasPendingMousemoveEvent:false,pendingMousemoveEvent:null,init:function(a,b){jayus.Entity.prototype.init.apply(this);this.children=new jayus.List(this);if(arguments.length===1){var c=a;c.parentElement.style.position="relative"}else{c=document.createElement("canvas");if(arguments.length){c.width=a;c.height=b}}this.canvas=c;this.width=c.width;this.height=c.height;
this.context=c.getContext("2d");jayus.displays.push(this);this.hookCursorListeners(this.canvas);this.addDefaultHandlers()},setBuffering:function(){},formContents:function(a,b){this.canvas.width=a;this.canvas.height=b;this.redrawAll=true;this.dirty(4)},processPendingMousemove:function(){this.hasPendingMousemoveEvent=false;return this.processMousemove(this.pendingMousemoveEvent)},processMousemove:function(a){if(!this.underCursor){this.underCursor=true;this.fire("cursorOver")}var b=a.offsetX===undefined?
a.layerX:a.offsetX,c=a.offsetY===undefined?a.layerY:a.offsetY;a={display:this,event:a,x:b,y:c,deltaX:b-this.cursor.x,deltaY:c-this.cursor.y};this.cursor.x=b;this.cursor.y=c;this.cursor.dependentCount&&this.cursor.dirty(2);this.fireOnCursor("cursorMove",a)||this.fire("cursorMove",a);this.startCursorUpdate()},hookCursorListeners:function(a){var b=this,c={event:null,display:b,x:null,y:null},d={event:null,display:b,x:null,y:null,scroll:null,xScroll:null,yScroll:null},e=function(g){c.event=g;c.x=g.offsetX===
undefined?g.layerX:g.offsetX;c.y=g.offsetY===undefined?g.layerY:g.offsetY},f=function(g,i,j,k){d.event=g;d.x=g.offsetX===undefined?g.layerX:g.offsetX;d.y=g.offsetY===undefined?g.layerY:g.offsetY;d.scroll=i;d.xScroll=j;d.yScroll=k},h=function(g){if(g.button===0)return"left";if(g.button===1)return"middle";if(g.button===2)return"right";return"unknown"};a.addEventListener("mousemove",function(g){if(b.pendMousemoveEvents){b.pendingMousemoveEvent=g;b.hasPendingMousemoveEvent=true}else b.processMousemove(g)});
a.addEventListener("mouseleave",function(g){b.processPendingMousemove();e(g);g=0;for(var i;g<3;g++){i=h(g);if(jayus[i+"Down"]){jayus[i+"Down"]=false;jayus.fire(i+"Release",c);b.fireOnCursor(i+"Release",c)}}if(jayus.cursorFocus!==null){jayus.cursorFocus.fire("cursorLeave");jayus.cursorFocus=null}b.underCursor=false;b.fire("cursorOut");b.removeCursorFromChildren()});if(this.suppressSelection){a.style.webkitUserSelect="none";a.style.mozUserSelect="none";a.onselectstart=function(){return false}}a.addEventListener("focus",
function(g){b.fire("focused",{event:g,display:b});b.focused=true;jayus.focusedDisplay=b;jayus.hasFocus=true});a.addEventListener("blur",function(g){b.fire("blurred",{event:g,display:b});b.focused=false;jayus.focusedDisplay=null;jayus.hasFocus=false});a.setAttribute("tabindex","1");a.style.outline=0;a.addEventListener("mousedown",function(g){b.hasPendingMousemoveEvent&&b.processPendingMousemove();b.focus();if(!b.underCursor){b.underCursor=true;b.fire("cursorOver")}e(g);var i=h(g),j=i+"Press";jayus[i+
"Down"]=true;if(jayus.fire(j,c)||b.fireOnCursor(j,c)||b.fire(j,c)){g.stopPropagation();g.preventDefault();return false}});a.addEventListener("mouseup",function(g){b.hasPendingMousemoveEvent&&b.processPendingMousemove();e(g);g=h(g);var i=g+"Release";jayus[g+"Down"]=false;jayus.fire(i,c);b.fireOnCursor(i,c);b.fire(i,c)});a.addEventListener("click",function(g){b.hasPendingMousemoveEvent&&b.processPendingMousemove();if(!b.underCursor){b.canvas.focus();b.underCursor=true;b.fire("cursorOver")}e(g);g=h(g);
jayus.fire(g+"Click",c)||b.fireOnCursor(g+"Click",c)||b.fire(g+"Click",c)});a.addEventListener("dblclick",function(g){b.hasPendingMousemoveEvent&&b.processPendingMousemove();if(!b.underCursor){b.underCursor=true;b.fire("cursorOver")}e(g);g=h(g);jayus.fire(g+"DoubleClick",c)||b.fireOnCursor(g+"DoubleClick",c)||b.fire(g+"DoubleClick",c)});a.addEventListener("contextmenu",function(g){b.suppressContextMenu&&g.preventDefault()});if(jayus.ua.browser==="Firefox")a.addEventListener("wheel",function(g){b.hasPendingMousemoveEvent&&
b.processPendingMousemove();if(!b.underCursor){b.underCursor=true;b.fire("cursorOver")}f(g,NaN,g.deltaX,g.deltaY);if(jayus.fire("scroll",d)||b.fireOnCursor("scroll",d)||b.fire("scroll",d))g.preventDefault()});else if(jayus.ua.browser==="IE")a.onmousewheel=function(g){b.hasPendingMousemoveEvent&&b.processPendingMousemove();if(!b.underCursor){b.underCursor=true;b.fire("cursorOver")}f(g,g.wheelDelta,g.wheelDeltaX,g.wheelDeltaY);if(jayus.fire("scroll",d)||b.fireOnCursor("scroll",d)||b.fire("scroll",d))return false};
else a.addEventListener("mousewheel",function(g){b.hasPendingMousemoveEvent&&b.processPendingMousemove();if(!b.underCursor){b.underCursor=true;b.fire("cursorOver")}f(g,-g.wheelDelta/120,g.wheelDeltaX/120,-g.wheelDeltaY/120);if(jayus.fire("scroll",d)||b.fireOnCursor("scroll",d)||b.fire("scroll",d))g.preventDefault()})},addDefaultHandlers:function(){},startCursorUpdate:function(){var a;if(this.underCursor&&this.propagateCursor){this.updateCursorOnChildren(this.cursor.x,this.cursor.y);this.cursorFocus=
a=this.findCursorAcceptor();if(jayus.cursorFocus!==a)if(jayus.cursorFocus===null||jayus.cursorFocus.canReleaseCursor){jayus.cursorFocus!==null&&jayus.cursorFocus.fire("cursorLeave");a!==null&&a.fire("cursorEnter");jayus.cursorFocus=a}}},getTopCanvas:function(){return this.hasOverlay?this.overlayCanvas:this.canvas},showDamage:false,hasOverlay:false,overlayCanvas:null,overlayContext:null,overlayFadeAnimator:null,initOverlay:function(){if(this.showDamage&&!this.hasOverlay){var a=document.createElement("canvas");
a.width=this.width;a.height=this.height;a.style.position="absolute";a.style.left=this.canvas.offsetLeft;a.style.top=this.canvas.offsetTop;a.style.opacity="0.5";this.overlayCanvas=a;this.overlayContext=a.getContext("2d");this.overlayContext.lineWidth=4;this.canvas.parentElement.appendChild(this.overlayCanvas);this.hasOverlay=true;this.hookCursorListeners(a);this.overlayFadeAnimator=(new jayus.Animator(function(b){a.style.opacity=0.5-0.5*b})).setDuration(500)}},clearDamage:function(){if(this.showDamage){this.initOverlay();
this.overlayContext.clearRect(0,0,this.width,this.height)}},paintDamage:function(a){this.paintOverlayRect(a,"red")},paintRedraw:function(a){this.paintOverlayRect(a,"yellow")},paintOverlayRect:function(a,b){if(this.showDamage){this.initOverlay();var c=this.overlayContext;c.fillStyle=b;c.fillRect(a.x,a.y,a.width,a.height);this.overlayCanvas.style.opacity="0.5";this.overlayFadeAnimator.start()}},setVisible:function(a){this.visible=a;this.canvas.style.visibility=a?"":"hidden";return this},setAlpha:function(a){if(this.actionsToAnimate){this.actionsToAnimate--;
return new jayus.MethodAnimator(this,this.setAlpha,this.alpha,a)}if(this.alpha!==a){this.alpha=a;this.canvas.style.opacity=a}return this},setInto:function(a){a.style.position="relative";this.visible&&a.appendChild(this.canvas);return this},focus:function(){this.canvas.focus();return this},blur:function(){this.canvas.blur();return this},isFullScreen:function(){return(document.fullscreenEnabled||document.mozFullScreenEnabled||document.webkitFullScreenEnabled)&&this.canvas===(document.fullscreenElement||
document.mozFullScreenElement||document.webkitFullScreenElement)},requestFullScreen:function(){var a=this.canvas;if(a.requestFullScreen)a.requestFullScreen();else if(a.mozRequestFullScreen)a.mozRequestFullScreen();else a.webkitRequestFullScreen&&a.webkitRequestFullScreen();return this.isFullScreen()},cancelFullScreen:function(){if(document.cancelFullScreen)document.cancelFullScreen();else if(document.mozCancelFullScreen)document.mozCancelFullScreen();else document.webkitCancelFullScreen&&document.webkitCancelFullScreen();
return this},getCursor:function(){return this.customIcon?this.customCursor:this.getTopCanvas().style.cursor},setCursor:function(a){if(typeof a==="string"){this.getTopCanvas().style.cursor=a;this.hasCustomCursor=false}else{this.getTopCanvas().style.cursor="none";this.hasCustomCursor=true;this.customCursor=a}return this},resetCursor:function(){this.getTopCanvas().style.cursor="";this.hasCustomCursor=false;this.customCursor=null}});jayus.Frame=jayus.RectEntity.extend(jayus.applyObject({brush:null,hasBrush:false,marginLeft:6,marginRight:6,marginTop:6,marginBottom:6,updateCursorOnChildren:function(a,b){if(this.propagateCursor){var c=this.parentToLocal(a,b);a=c.x;b=c.y;this.localX=a;this.localY=b;this.child.updateCursor(a-this.marginLeft,b-this.marginTop)}},init:function(a){jayus.Entity.prototype.init.apply(this);this.setChild(a)},setChild:function(a){jayus.Wrapper.setChild.call(this,a);this.changeSize(a.width+this.marginLeft+
this.marginRight,a.height+this.marginTop+this.marginBottom);return this},setBrush:function(a){this.hasBrush&&this.brush.detach(this);a instanceof jayus.Brush||(a=new jayus.Brush(a));this.brush=a;this.brush.attach(this);this.hasBrush=true;return this.dirty(16)},clearBrush:function(){if(this.hasBrush){this.brush.detach(this);this.brush=null;this.hasBrush=false;this.dirty(16)}return this},hasFlexibleWidth:function(){return this.child.hasFlexibleWidth()},hasFlexibleHeight:function(){return this.child.hasFlexibleHeight()},
childSizeChanged:function(){this.width=this.child.width+this.marginLeft+this.marginRight;this.height=this.child.height+this.marginTop+this.marginBottom;this.fire("resized");this.hasParent&&this.parent.childSizeChanged(this)},formContents:function(a,b){this.child.frozen--;this.child.setOrigin(this.marginLeft,this.marginTop);this.child.changeSize(a-this.marginLeft-this.marginRight,b-this.marginTop-this.marginBottom);this.child.frozen++},setMargin:function(a,b,c,d){if(arguments.length===1)d=c=b=a;this.marginLeft=
a;this.marginRight=b;this.marginTop=c;this.marginBottom=d;this.child.frozen++;this.child.hasFlexibleWidth()?this.child.setWidth(this.width-this.marginLeft-this.marginRight):this.changeSize(this.child.width+a+b,this.child.height);this.child.hasFlexibleHeight()?this.child.setHeight(this.height-this.marginTop-this.marginBottom):this.changeSize(this.child.width,this.child.height+c+d);this.child.frozen--;return this},setMarginLeft:function(a){return this.setMargin(a,this.marginRight,this.marginTop,this.marginBottom)},
setMarginRight:function(a){return this.setMargin(this.marginLeft,a,this.marginTop,this.marginBottom)},setMarginTop:function(a){return this.setMargin(this.marginLeft,this.marginRight,a,this.marginBottom)},setMarginBottom:function(a){return this.setMargin(this.marginLeft,this.marginRight,this.marginTop,a)},paintContents:function(a){if(this.hasBrush)if(this.brush.fill||this.brush.stroking){a.save();this.brush.applyTo(a);a.beginPath();a.rect(0,0,this.width,this.height);this.brush.stroking&&this.brush.strokeFirst&&
a.stroke();this.brush.filling&&a.fill();this.brush.stroking&&!this.brush.strokeFirst&&a.stroke();a.restore()}a.save();this.child.drawOntoContext(a);this.child.dirtied=false;a.restore()}},jayus.copyObject(jayus.Wrapper)));jayus.EditableFrame=jayus.Frame.extend({minW:20,minH:20,maxW:Infinity,maxH:Infinity,enabledHandles:{nw:1,n:1,ne:1,e:1,se:1,s:1,sw:1,w:1},cornerThreshold:6,edgeThreshold:5,state:"",display:null,init:function(a){jayus.Entity.prototype.init.apply(this);this.setChild(a);this.initHandlers()},initHandlers:function(){this.addHandler("cursorMove",function(a){if(!this.dragging){this.state="";this.display=a.display;var b=a.display.cursor,c=this.child.hasFlexibleWidth(),d=this.child.hasFlexibleHeight();if(c&&
d)if(this.enabledHandles.nw&&jayus.distance(this.getPosAt(0,0),b)<this.cornerThreshold)this.state="nw";else if(this.enabledHandles.ne&&jayus.distance(this.getPosAt(1,0),b)<this.cornerThreshold)this.state="ne";else if(this.enabledHandles.sw&&jayus.distance(this.getPosAt(0,1),b)<this.cornerThreshold)this.state="sw";else if(this.enabledHandles.se&&jayus.distance(this.getPosAt(1,1),b)<this.cornerThreshold)this.state="se";if(this.state===""&&c)if(this.enabledHandles.w&&Math.abs(this.x-a.x)<this.edgeThreshold)this.state=
"w";else if(this.enabledHandles.e&&Math.abs(this.x+this.width-a.x)<this.edgeThreshold)this.state="e";if(this.state===""&&d)if(this.enabledHandles.n&&Math.abs(this.y-a.y)<this.edgeThreshold)this.state="n";else if(this.enabledHandles.s&&Math.abs(this.y+this.height-a.y)<this.edgeThreshold)this.state="s";this.state!==""?this.display.setCursor(this.state+"-resize"):this.display.resetCursor()}});this.addHandler("cursorOut",function(){if(!this.dragging){this.display.resetCursor();this.state=""}});this.addHandler("leftPress",
function(a){this.dragging=true;if(this.state===""){this.display.setCursor("move");this.fire("dragStart")}else if(this.state==="nw")this.start=this.getPosAt(1,1);else if(this.state==="n"||this.state==="e"||this.state==="ne")this.start=this.getPosAt(0,1);else if(this.state==="sw"||this.state==="w")this.start=this.getPosAt(1,0);else if(this.state==="s"||this.state==="se")this.start=this.getPosAt(0,0);var b=this;jayus.interceptNextEvent("leftRelease",function(){this.dragging=false;if(this.state===""){this.fire("dragEnd");
this.display.resetCursor()}},{context:this});var c=function(d){if(b.dragging){if(b.state==="")b.translate(d.deltaX,d.deltaY);else{var e=null,f=null,h=0,g=0;if(b.state==="nw"){g=h=1;e=b.start.x-d.x;f=b.start.y-d.y}else if(b.state==="n"){g=1;f=b.start.y-d.y}else if(b.state==="ne"){g=1;e=d.x-b.start.x;f=b.start.y-d.y}else if(b.state==="sw"){h=1;e=b.start.x-d.x;f=d.y-b.start.y}else if(b.state==="s")f=d.y-b.start.y;else if(b.state==="se"){e=d.x-b.start.x;f=d.y-b.start.y}else if(b.state==="e")e=d.x-b.start.x;
else if(b.state==="w"){h=1;e=b.start.x-d.x}d=b.getPosAt(h,g);if(e!==null)if(e<b.minW+b.marginLeft+b.marginRight)e=b.minW+b.marginLeft+b.marginRight;else if(e>b.maxW+b.marginLeft+b.marginRight)e=b.maxW+b.marginLeft+b.marginRight;if(f!==null)if(f<b.minH+b.marginTop+b.marginBottom)f=b.minH+b.marginTop+b.marginBottom;else if(f>b.maxH+b.marginTop+b.marginBottom)f=b.maxH+b.marginTop+b.marginBottom;if(e===null)e=b.width;if(f===null)f=b.height;b.changeSize(e,f);b.setPosAt(h,g,d)}b.display.interceptNextEvent("cursorMove",
c);return true}};a.display.interceptNextEvent("cursorMove",c);return true})},setMinimumSize:function(a,b){this.minW=a;this.minH=b;return this}});jayus.FlowLayout=jayus.RectEntity.extend({alignment:0,width:100,height:100,init:function(){jayus.Entity.prototype.init.apply(this);this.children=new jayus.List(this)},hasFlexibleWidth:function(){return true},hasFlexibleHeight:function(){return false},componentDirtied:function(a,b,c){c===4?this.reform():this.dirty(16)},listItemAdded:function(a,b){b.setParent(this);this.reform()},listItemsAdded:function(a,b){for(var c=0;c<b.length;c++)b[c].setParent(this);this.reform()},listItemRemoved:function(a,b){b.removeParent();
this.reform()},listItemsRemoved:function(a,b){for(var c=0;c<b.length;c++)b[c].removeParent();this.reform()},setAlignment:function(a){if(this.alignment!==a){this.alignment=a;this.reform()}return this},getAlignment:function(){return this.alignment},reform:function(){this.formContents(this.width,this.height);this.dirty(4)},formContents:function(a,b){if(!(a===this.width&&b>this.height)){for(var c=0,d,e=0,f,h,g,i,j,k=[];c!==this.children.items.length;){f=[];d=g=h=0;i=this.children.items[c];j=i.width;do{i.x=
d;i.y=e;f.push(i);h+=j;d+=j;if(i.height>g)g=i.height;c++;if(c===this.children.items.length)break;i=this.children.items[c];j=i.width}while(h+j<a);if(this.alignment!==0)for(d=0;d<f.length;d++){i=f[d];i.x+=(a-h)*this.alignment}for(d=0;d<f.length;d++){i=f[d];if(typeof i.verticalAlign==="number")i.y+=i.verticalAlign*(g-i.height)}e+=g;k.push(g)}for(c=0;c<this.children.items.length;c++){i=this.children.items[c];i.fire("moved")}this.lineHeights=k}},paintContents:jayus.Scene.prototype.paintContents});
jayus.applyObject(jayus.Group,jayus.FlowLayout.prototype);jayus.Stack=jayus.RectEntity.extend({spacing:8,reversed:false,isParent:true,listItemAdded:function(){this.formSelf()},listItemRemoved:function(){this.formSelf()},listItemsAdded:function(a,b){for(var c=0;c<b.length;c++)this.listItemAdded(a,b[c])},listItemsRemoved:function(a,b){for(var c=0;c<b.length;c++)this.listItemRemoved(a,b[c])},childDirtied:function(){this.dirty()},childMoved:function(){this.dirty()},childSizeChanged:function(){this.formSelf()},init:function(){jayus.Entity.prototype.init.apply(this,
arguments);this.children=new jayus.List(this)},hasFlexibleWidth:function(){return false},hasFlexibleHeight:function(){return false},setReversed:function(a){if(this.reversed!==a){this.reversed=a;this.formSelf()}return this},setSpacing:function(a){if(this.spacing!==a){this.spacing=a;this.formSelf()}return this},findGreatestMinimalChildWidth:function(){var a,b=0;for(a=0;a<this.children.items.length;a++)b=Math.max(b,this.children.items[a].minW);return b},findGreatestMinimalChildHeight:function(){var a,
b=0;for(a=0;a<this.children.items.length;a++)b=Math.max(b,this.children.items[a].minH);return b},reform:function(){this.formSelf(this.width,this.height)},paintContents:jayus.Scene.prototype.paintContents});jayus.applyObject(jayus.Group,jayus.Stack.prototype);
jayus.hStack=jayus.Stack.extend({automaticHeight:true,formSelf:function(){var a=0,b=0,c,d;if(this.reversed)for(d=this.children.items.length-1;d>=0;d--){c=this.children.items[d];c.setX(a);a+=c.width+this.spacing;if(this.automaticHeight){c=c.height;if(c>b)b=c}}else for(d=0;d<this.children.items.length;d++){c=this.children.items[d];c.setX(a);a+=c.width+this.spacing;if(this.automaticHeight){c=c.height;if(c>b)b=c}}a=a-this.spacing;if(this.automaticHeight)height=b;this.changeSize(a,height)}});
jayus.vStack=jayus.Stack.extend({automaticWidth:true,getAutomaticWidth:function(){return this.automaticWidth},setAutomaticWidth:function(a){if(this.automaticWidth!==a){this.automaticWidth=a;this.reform()}return this},formSelf:function(){for(var a=0,b=0,c=0;c<this.children.items.length;c++){var d=this.children.items[c];d.frozen++;d.setY(a);d.frozen--;a+=d.height+this.spacing;if(this.automaticWidth){d=d.width;if(d>b)b=d}}a=a-this.spacing;c=this.width;if(this.automaticWidth)c=b;this.changeSize(c,a)}});jayus.Box=jayus.RectEntity.extend({width:100,height:100,spacing:8,reversed:false,isParent:true,init:function(){jayus.Entity.prototype.init.apply(this,arguments);this.children=new jayus.List(this)},componentDirtied:function(a,b,c){c===4?this.reform():this.dirty(16)},listItemAdded:function(a,b){b.setParent(this);this.reform()},listItemsAdded:function(a,b){for(var c=0;c<b.length;c++)b[c].setParent(this);this.reform()},listItemRemoved:function(a,b){b.removeParent();this.reform()},listItemsRemoved:function(a,
b){for(var c=0;c<b.length;c++)b[c].removeParent();this.reform()},reform:function(){this.formContents(this.width,this.height);this.dirty(4)},setReversed:function(a){if(this.reversed!==a){this.reversed=a;this.reform()}return this},setSpacing:function(a){if(this.spacing!==a){this.spacing=a;this.reform()}return this},findGreatestMinimalChildWidth:function(){for(var a=0,b=0;b<this.children.items.length;b++)a=Math.max(a,this.children.items[b].minW);return a},findGreatestMinimalChildHeight:function(){for(var a=
0,b=0;b<this.children.items.length;b++)a=Math.max(a,this.children.items[b].minH);return a},paintContents:jayus.Scene.prototype.paintContents});jayus.applyObject(jayus.Group,jayus.Box.prototype);
jayus.hBox=jayus.Box.extend({hasFlexibleWidth:function(){if(!this.children.items.length)return true;var a,b;for(a=0;a<this.children.items.length;a++){b=this.children.items[a];if(b.hasFlexibleWidth())return true}return false},hasFlexibleHeight:function(){return true},formContents:function(a,b){var c,d,e=0,f=a-(this.children.items.length-1)*this.spacing,h=0,g=0;for(c=0;c<this.children.items.length;c++){d=this.children.items[c];if(typeof d.policy!=="object")d.policy=new jayus.SizePolicy;if(d.hasFlexibleWidth()){g+=
d.policy.size;if(d.policy.expand)h+=d.policy.weight}else g+=d.width}var i=f-g;for(c=0;c<this.children.items.length;c++){d=this.children.items[c];g=d.hasFlexibleHeight()?b:d.height;f=d.hasFlexibleWidth()?d.policy.expand?d.policy.size+i*(d.policy.weight/h):d.policy.size:d.width;d.x=e;e+=f+this.spacing;d.frozen--;d.changeSize(f,g);d.frozen++}}});
jayus.vBox=jayus.Box.extend({hasFlexibleWidth:function(){return true},hasFlexibleHeight:function(){if(!this.children.items.length)return true;var a,b;for(a=0;a<this.children.items.length;a++){b=this.children.items[a];if(b.hasFlexibleHeight())return true}return false},formContents:function(a,b){var c,d,e=0,f=b-(this.children.items.length-1)*this.spacing,h=0,g=0;for(c=0;c<this.children.items.length;c++){d=this.children.items[c];if(typeof d.policy!=="object")d.policy=new jayus.SizePolicy;if(d.hasFlexibleHeight()){g+=
d.policy.size;if(d.policy.expand)h+=d.policy.weight}else g+=d.height}var i=f-g;for(c=0;c<this.children.items.length;c++){d=this.children.items[c];f=d.hasFlexibleWidth()?a:d.width;g=d.hasFlexibleHeight()?d.policy.expand?d.policy.size+i*(d.policy.weight/h):d.policy.size:d.height;d.y=e;e+=g+this.spacing;d.frozen--;d.changeSize(f,g);d.frozen++}}});jayus.TiledMap=jayus.RectEntity.extend({loaded:false,filename:null,map:null,tileWidth:0,tileHeight:0,init:function(a){jayus.Entity.prototype.init.apply(this);arguments.length&&this.setMap(a)},setMap:overloadArgumentType({object:function(a){this.map=a;this.loaded=true},string:function(a){this.map=jayus.objects.get(a);for(a=0;a<this.map.tilesets.length;a++){var b=this.map.tilesets[a];jayus.images.load(b.image);var c=new jayus.SpriteSheet;c.setSpriteSize(b.tilewidth,b.tileheight);jayus.images.get(b.image).sheet=
c;this.tileWidth=b.tilewidth;this.tileHeight=b.tileheight}this.loaded=true;this.changeSize(this.map.width*this.map.tilewidth,this.map.height*this.map.tileheight)}}),getTileAt:function(a,b){if(arguments.length===1){b=a.y;a=a.x}a-=this.x;b-=this.y;return new jayus.Point(Math.floor(a/this.map.tilewidth),Math.floor(b/this.map.tileheight))},getSlotFrame:function(a,b){if(arguments.length===1){b=a.y;a=a.x}return new jayus.Rectangle(this.x+a*this.map.tilewidth,this.y+b*this.map.tileheight,this.map.tilewidth,
this.map.tileheight)},isLayerVisible:function(a){return this.map.layers[a].visible},setLayerVisibility:function(a,b){var c=this.map.layers[a];if(c.visible!==b){c.visible=b;this.dirty()}return this},showLayer:function(a){return this.setLayerVisibility(a,true)},hideLayer:function(a){return this.setLayerVisibility(a,false)},paintContents:function(a){var b,c=this.map.tilesets[0],d=jayus.images.get(c.image),e=d.sheet,f=e.spriteWidth,h=e.spriteHeight,g,i,j,k,l;for(b=0;b<this.map.tilesets.length;b++){c=
this.map.tilesets[b];jayus.images.isLoaded(c.image)||console.warn('TiledMap.paintContents() - Tileset "'+c.image+'" not yet loaded')}for(b=0;b<this.map.layers.length;b++){g=this.map.layers[b];if(g.type==="tilelayer"&&g.visible)for(i=0;i<g.height;i++)for(j=0;j<g.width;j++){k=g.data[i*g.width+j]-1;if(k!==-1){l=k%(c.imagewidth/c.tilewidth);k=(k-l)/(c.imagewidth/c.tilewidth);l=e.marginX+l*f;k=e.marginY+k*h;a.drawImage(d,l,k,f,h,j*f,i*h,f,h)}}}}});
